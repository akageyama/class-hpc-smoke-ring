<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="渦輪の形成と伝播の3次元シミュレーション + 可視化">
    
    <meta name="author" content="" >
    <link rel="icon" href="../favicon.png">

    <title>solver.f90 &ndash; Smoke Ring</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Smoke Ring </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/main_m.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/main_m.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>solver.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title="27.8% of total for source files.">287 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/solver.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">solver.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/solver_m.html">solver_m</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/solver.f90.html#src">solver.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      <hr>
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: sourcefile~~solver.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilesolverf90EfferentGraph" width="461pt" height="222pt"
 viewBox="0.00 0.00 460.64 221.97" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~solver.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 217.97)">
<title>sourcefile~~solver.f90~~EfferentGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-217.97 456.64,-217.97 456.64,4 -4,4"/>
<!-- sourcefile~solver.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~solver.f90</title>
<polygon fill="none" stroke="black" points="452.62,-100.26 395.72,-100.26 395.72,-78.24 452.62,-78.24 452.62,-100.26"/>
<text text-anchor="middle" x="424.17" y="-86.1" font-family="Helvetica,sans-Serif" font-size="10.50">solver.f90</text>
</g>
<!-- sourcefile~field.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~field.f90</title>
<g id="a_sourcefile~~solver.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/field.f90.html" xlink:title="field.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="357.34,-139.26 303.34,-139.26 303.34,-117.24 357.34,-117.24 357.34,-139.26"/>
<text text-anchor="middle" x="330.34" y="-125.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">field.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~field.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~field.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M397.1,-100.32C387.7,-104.31 376.92,-108.89 366.85,-113.17"/>
<polygon fill="#ff0000" stroke="#ff0000" points="365.31,-110.02 357.47,-117.15 368.04,-116.46 365.31,-110.02"/>
</g>
<!-- sourcefile~job.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~job.f90</title>
<g id="a_sourcefile~~solver.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/job.f90.html" xlink:title="job.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="259.72,-179.26 205.72,-179.26 205.72,-157.24 259.72,-157.24 259.72,-179.26"/>
<text text-anchor="middle" x="232.72" y="-165.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">job.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~job.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~job.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M329.34,-207.25C316.41,-211.98 284.57,-196.99 261.17,-184.25"/>
<polygon fill="#ff0000" stroke="#ff0000" points="262.8,-181.15 252.36,-179.34 259.39,-187.26 262.8,-181.15"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M419.21,-100.38C409.29,-126.18 380.58,-189.22 331.34,-207.25"/>
</g>
<!-- sourcefile~ut.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~ut.f90</title>
<g id="a_sourcefile~~solver.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/ut.f90.html" xlink:title="ut.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="164.46,-100.26 110.46,-100.26 110.46,-78.24 164.46,-78.24 164.46,-100.26"/>
<text text-anchor="middle" x="137.46" y="-86.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ut.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~ut.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~ut.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M395.38,-87.9C377.13,-87.35 352.77,-87.24 331.34,-89.25"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M329.34,-89.25C275.66,-94.29 213.11,-92.92 174.64,-91.26"/>
<polygon fill="#ff0000" stroke="#ff0000" points="174.61,-87.75 164.46,-90.79 174.29,-94.75 174.61,-87.75"/>
</g>
<!-- sourcefile~constants.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~constants.f90</title>
<g id="a_sourcefile~~solver.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/constants.f90.html" xlink:title="constants.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="74.69,-100.26 -0.23,-100.26 -0.23,-78.24 74.69,-78.24 74.69,-100.26"/>
<text text-anchor="middle" x="37.23" y="-86.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">constants.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~constants.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~constants.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M329.34,-207.25C289.43,-221.86 275.43,-199.13 233.72,-207.25"/>
</g>
<!-- sourcefile~grid.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~grid.f90</title>
<g id="a_sourcefile~~solver.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/grid.f90.html" xlink:title="grid.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="259.72,-138.26 205.72,-138.26 205.72,-116.24 259.72,-116.24 259.72,-138.26"/>
<text text-anchor="middle" x="232.72" y="-124.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">grid.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~grid.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~grid.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M329.34,-89.25C305.26,-91.51 279.9,-102.01 261.36,-111.4"/>
<polygon fill="#ff0000" stroke="#ff0000" points="259.54,-108.4 252.32,-116.16 262.8,-114.6 259.54,-108.4"/>
</g>
<!-- sourcefile~debug.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~debug.f90</title>
<g id="a_sourcefile~~solver.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/debug.f90.html" xlink:title="debug.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="359.55,-61.26 301.13,-61.26 301.13,-39.24 359.55,-39.24 359.55,-61.26"/>
<text text-anchor="middle" x="330.34" y="-47.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">debug.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~debug.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~debug.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M397.1,-78.18C387.7,-74.19 376.92,-69.61 366.85,-65.33"/>
<polygon fill="#ff0000" stroke="#ff0000" points="368.04,-62.04 357.47,-61.35 365.31,-68.48 368.04,-62.04"/>
</g>
<!-- sourcefile~params.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~params.f90</title>
<g id="a_sourcefile~~solver.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/params.f90.html" xlink:title="params.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="264.75,-22.26 200.69,-22.26 200.69,-0.24 264.75,-0.24 264.75,-22.26"/>
<text text-anchor="middle" x="232.72" y="-8.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">params.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~params.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~params.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M414.68,-77.99C403.64,-64.26 383,-41.49 359.69,-30.25 333.34,-17.54 300.59,-12.89 275.09,-11.37"/>
<polygon fill="#ff0000" stroke="#ff0000" points="275.14,-7.87 264.99,-10.9 274.82,-14.86 275.14,-7.87"/>
</g>
<!-- sourcefile~field.f90&#45;&gt;sourcefile~constants.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~field.f90&#45;&gt;sourcefile~constants.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M321.78,-139.42C307.45,-159.28 274.09,-199.39 233.72,-207.25"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M231.72,-207.25C191.03,-215.17 178.76,-216.94 138.46,-207.25"/>
</g>
<!-- sourcefile~field.f90&#45;&gt;sourcefile~grid.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~field.f90&#45;&gt;sourcefile~grid.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M303.21,-127.98C292.99,-127.87 281.08,-127.75 270.05,-127.63"/>
<polygon fill="#ff0000" stroke="#ff0000" points="269.85,-124.13 259.82,-127.52 269.78,-131.13 269.85,-124.13"/>
</g>
<!-- sourcefile~job.f90&#45;&gt;sourcefile~ut.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~job.f90&#45;&gt;sourcefile~ut.f90</title>
<path fill="none" stroke="#ffda00" stroke-dasharray="5,2" d="M214.17,-157.18C209.6,-154.1 204.76,-150.67 200.46,-147.25 184.94,-134.91 168.61,-119.52 156.6,-107.7"/>
<polygon fill="#ffda00" stroke="#ffda00" points="158.95,-105.09 149.39,-100.51 154,-110.05 158.95,-105.09"/>
</g>
<!-- sourcefile~job.f90&#45;&gt;sourcefile~constants.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~job.f90&#45;&gt;sourcefile~constants.f90</title>
<path fill="none" stroke="#ffda00" stroke-dasharray="5,2" d="M218.89,-179.41C201.31,-193.33 168.49,-214.47 138.46,-207.25"/>
</g>
<!-- sourcefile~ut.f90&#45;&gt;sourcefile~constants.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~ut.f90&#45;&gt;sourcefile~constants.f90</title>
<path fill="none" stroke="#48ff00" stroke-dasharray="5,2" d="M110.39,-89.25C102.55,-89.25 93.69,-89.25 84.93,-89.25"/>
<polygon fill="#48ff00" stroke="#48ff00" points="84.77,-85.75 74.77,-89.25 84.77,-92.75 84.77,-85.75"/>
</g>
<!-- sourcefile~grid.f90&#45;&gt;sourcefile~ut.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~grid.f90&#45;&gt;sourcefile~ut.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M205.24,-116.46C195.51,-112.5 184.33,-107.94 173.94,-103.71"/>
<polygon fill="#0091ff" stroke="#0091ff" points="175.26,-100.47 164.68,-99.93 172.62,-106.95 175.26,-100.47"/>
</g>
<!-- sourcefile~grid.f90&#45;&gt;sourcefile~constants.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~grid.f90&#45;&gt;sourcefile~constants.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M136.46,-207.25C88.96,-195.82 59.12,-140.28 46.01,-109.64"/>
<polygon fill="#0091ff" stroke="#0091ff" points="49.21,-108.24 42.2,-100.3 42.73,-110.89 49.21,-108.24"/>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M214.15,-138.3C209.58,-141.37 204.74,-144.81 200.46,-148.25 170.78,-172.05 175.44,-216.15 138.46,-207.25"/>
</g>
<!-- sourcefile~debug.f90&#45;&gt;sourcefile~ut.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~debug.f90&#45;&gt;sourcefile~ut.f90</title>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M231.72,-50.25C207.93,-52.66 183.04,-63.55 164.97,-73.21"/>
<polygon fill="#4800ff" stroke="#4800ff" points="163.22,-70.18 156.18,-78.1 166.62,-76.3 163.22,-70.18"/>
</g>
<!-- sourcefile~debug.f90&#45;&gt;sourcefile~constants.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~debug.f90&#45;&gt;sourcefile~constants.f90</title>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M231.72,-50.25C190.48,-54.43 178.22,-38.54 138.46,-50.25"/>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M300.81,-48.75C281.76,-48.12 256.18,-47.97 233.72,-50.25"/>
</g>
<!-- sourcefile~debug.f90&#45;&gt;sourcefile~params.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~debug.f90&#45;&gt;sourcefile~params.f90</title>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M302.19,-39.18C292.3,-35.14 280.95,-30.51 270.37,-26.2"/>
<polygon fill="#4800ff" stroke="#4800ff" points="271.51,-22.89 260.93,-22.35 268.87,-29.37 271.51,-22.89"/>
</g>
<!-- sourcefile~params.f90&#45;&gt;sourcefile~ut.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~params.f90&#45;&gt;sourcefile~ut.f90</title>
<path fill="none" stroke="#ff00da" stroke-dasharray="5,2" d="M217.63,-22.35C212.23,-26.65 206.03,-31.64 200.46,-36.25 186.45,-47.83 170.9,-61.13 158.87,-71.5"/>
<polygon fill="#ff00da" stroke="#ff00da" points="156.45,-68.97 151.18,-78.16 161.03,-74.27 156.45,-68.97"/>
</g>
<!-- sourcefile~params.f90&#45;&gt;sourcefile~constants.f90 -->
<g id="sourcefile~~solver.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~params.f90&#45;&gt;sourcefile~constants.f90</title>
<path fill="none" stroke="#ff00da" stroke-dasharray="5,2" d="M136.46,-50.25C114.42,-56.74 90.45,-66.21 71.7,-74.19"/>
<polygon fill="#ff00da" stroke="#ff00da" points="70.21,-71.03 62.42,-78.21 72.98,-77.45 70.21,-71.03"/>
<path fill="none" stroke="#ff00da" stroke-dasharray="5,2" d="M209.23,-22.3C190.65,-31.02 163.37,-42.91 138.46,-50.25"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="186pt" height="31pt"
 viewBox="0.00 0.00 186.41 30.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 26.5)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-26.5 182.41,-26.5 182.41,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="65.16,-22.26 -0.05,-22.26 -0.05,-0.24 65.16,-0.24 65.16,-22.26"/>
<text text-anchor="middle" x="32.55" y="-8.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="178.26,-22.26 82.84,-22.26 82.84,-0.24 178.26,-0.24 178.26,-22.26"/>
<text text-anchor="middle" x="130.55" y="-8.1" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: sourcefile~~solver.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilesolverf90AfferentGraph" width="262pt" height="50pt"
 viewBox="0.00 0.00 261.90 49.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~solver.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 45.5)">
<title>sourcefile~~solver.f90~~AfferentGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-45.5 257.9,-45.5 257.9,4 -4,4"/>
<!-- sourcefile~solver.f90 -->
<g id="sourcefile~~solver.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~solver.f90</title>
<polygon fill="none" stroke="black" points="56.92,-41.26 0.03,-41.26 0.03,-19.24 56.92,-19.24 56.92,-41.26"/>
<text text-anchor="middle" x="28.47" y="-27.1" font-family="Helvetica,sans-Serif" font-size="10.50">solver.f90</text>
</g>
<!-- sourcefile~main.f90 -->
<g id="sourcefile~~solver.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~main.f90</title>
<g id="a_sourcefile~~solver.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/main.f90.html" xlink:title="main.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="253.9,-41.26 199.9,-41.26 199.9,-19.24 253.9,-19.24 253.9,-41.26"/>
<text text-anchor="middle" x="226.9" y="-27.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">main.f90</text>
</a>
</g>
</g>
<!-- sourcefile~main.f90&#45;&gt;sourcefile~solver.f90 -->
<g id="sourcefile~~solver.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~main.f90&#45;&gt;sourcefile~solver.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M199.66,-30.77C188.62,-30.96 175.64,-31.16 163.9,-31.25 132.37,-31.5 124.48,-31.5 92.95,-31.25 84.56,-31.18 75.56,-31.07 67.04,-30.94"/>
<polygon fill="#ff0000" stroke="#ff0000" points="67.02,-27.44 56.97,-30.78 66.91,-34.44 67.02,-27.44"/>
</g>
<!-- sourcefile~slicedata.f90 -->
<g id="sourcefile~~solver.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~slicedata.f90</title>
<g id="a_sourcefile~~solver.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/slicedata.f90.html" xlink:title="slicedata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="163.88,-22.26 92.97,-22.26 92.97,-0.24 163.88,-0.24 163.88,-22.26"/>
<text text-anchor="middle" x="128.43" y="-8.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">slicedata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~main.f90&#45;&gt;sourcefile~slicedata.f90 -->
<g id="sourcefile~~solver.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~main.f90&#45;&gt;sourcefile~slicedata.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M199.79,-25.11C191.77,-23.53 182.69,-21.74 173.8,-19.99"/>
<polygon fill="#00ffff" stroke="#00ffff" points="174.38,-16.54 163.9,-18.04 173.03,-23.4 174.38,-16.54"/>
</g>
<!-- sourcefile~slicedata.f90&#45;&gt;sourcefile~solver.f90 -->
<g id="sourcefile~~solver.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~slicedata.f90&#45;&gt;sourcefile~solver.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M92.89,-17.95C84.51,-19.57 75.51,-21.32 67,-22.97"/>
<polygon fill="#ff0000" stroke="#ff0000" points="66.09,-19.58 56.94,-24.92 67.42,-26.45 66.09,-19.58"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="186pt" height="31pt"
 viewBox="0.00 0.00 186.41 30.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 26.5)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-26.5 182.41,-26.5 182.41,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="65.16,-22.26 -0.05,-22.26 -0.05,-0.24 65.16,-0.24 65.16,-22.26"/>
<text text-anchor="middle" x="32.55" y="-8.1" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="178.26,-22.26 82.84,-22.26 82.84,-0.24 178.26,-0.24 178.26,-22.26"/>
<text text-anchor="middle" x="130.55" y="-8.1" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/solver_m.html">solver_m</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/solver.f90.html#src">solver.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!*******************************************************************</span>
<a name="ln-2"></a><span class="c">!&gt; author: Akira Kageyama</span>
<a name="ln-3"></a><span class="c">!  license: MIT</span>
<a name="ln-4"></a><span class="c">!  date: 2020.01.22</span>
<a name="ln-5"></a><span class="c">!</span>
<a name="ln-6"></a><span class="c">!  ナビエ・ストークス方程式ソルバ</span>
<a name="ln-7"></a><span class="c">!</span>
<a name="ln-8"></a><span class="c">!  @note</span>
<a name="ln-9"></a><span class="c">!    Initialize_done, Viscosity など、頭文字だけが大文字の</span>
<a name="ln-10"></a><span class="c">!    変数名はこのモジュール全体にscopeを持つ変数である。</span>
<a name="ln-11"></a><span class="c">!    つまりこのモジュールの中の任意のサブルーチン・関数からアクセスできる。</span>
<a name="ln-12"></a><span class="c">!    ただし、このモジュールの外からはアクセスできない（privateである）</span>
<a name="ln-13"></a><span class="c">!</span>
<a name="ln-14"></a><span class="c">!  @note</span>
<a name="ln-15"></a><span class="c">!    サブルーチンsubfield_velでは構造体の割り算</span>
<a name="ln-16"></a><span class="c">!       vel = fluid%flux / fluid%density </span>
<a name="ln-17"></a><span class="c">!    をコメントアウトとしている。</span>
<a name="ln-18"></a><span class="c">!    Fortranコンパイラが自己定義演算子を問題なく使えるのであれば</span>
<a name="ln-19"></a><span class="c">!    コメントを外してこれを使うほうが記述が簡潔になる。</span>
<a name="ln-20"></a><span class="c">!    詳しくはfieldモジュールを見よ。</span>
<a name="ln-21"></a><span class="c">!     </span>
<a name="ln-22"></a><span class="c">!    サブルーチンsolver__advanceでの</span>
<a name="ln-23"></a><span class="c">!        gluid = fluid + dfluid01*0.5_DR</span>
<a name="ln-24"></a><span class="c">!    などといった記述についても同様。</span>
<a name="ln-25"></a><span class="c">!</span>
<a name="ln-26"></a><span class="c">! @bug</span>
<a name="ln-27"></a><span class="c">!    サブルーチン solver__diagnosis の発散判定で</span>
<a name="ln-28"></a><span class="c">!        if ( maxval(fluid%flux%x) &gt; ABNORMALLY_LARGE ) then</span>
<a name="ln-29"></a><span class="c">!    としているところ、正しくは</span>
<a name="ln-30"></a><span class="c">!        if ( maxval(abs(fluid%flux%x)) &gt; ABNORMALLY_LARGE ) then</span>
<a name="ln-31"></a><span class="c">!    とすべき。このままだと-x方向に大きな値があるときに引っかからない。</span>
<a name="ln-32"></a><span class="c">! </span>
<a name="ln-33"></a><span class="c">!  @bug</span>
<a name="ln-34"></a><span class="c">!    関数 solver__set_time_step で</span>
<a name="ln-35"></a><span class="c">!       vmax = maxval(sqrt(vel%x**2+vel%y**2+vel%z**2))</span>
<a name="ln-36"></a><span class="c">!    という演算はmaxvalとsqrtは交換して</span>
<a name="ln-37"></a><span class="c">!       vmax = sqrt(maxval(vel%x**2+vel%y**2+vel%z**2))</span>
<a name="ln-38"></a><span class="c">!    とした方が速くなる可能性が高い。</span>
<a name="ln-39"></a><span class="c">!    このままだと3次元配列の全要素にsqrt</span>
<a name="ln-40"></a><span class="c">!    を掛けてからそのmaxvalをとっているが、この順番は</span>
<a name="ln-41"></a><span class="c">!    逆にした方が速いだろう。</span>
<a name="ln-42"></a><span class="c">!</span>
<a name="ln-43"></a><span class="c">!   @bug</span>
<a name="ln-44"></a><span class="c">!    その少し下の</span>
<a name="ln-45"></a><span class="c">!       sound_v = GAMMA*maxval(sqrt(GASS_CONST_FOR_AIR*tm)) </span>
<a name="ln-46"></a><span class="c">!    も同様に</span>
<a name="ln-47"></a><span class="c">!       sound_v = GAMMA*sqrt(maxval(GASS_CONST_FOR_AIR*tm)) </span>
<a name="ln-48"></a><span class="c">!    とすべきだろう。</span>
<a name="ln-49"></a><span class="c">!</span>
<a name="ln-50"></a>
<a name="ln-51"></a><span class="k">module </span><span class="n">solver_m</span>
<a name="ln-52"></a>  <span class="k">use </span><span class="n">constants_m</span>  <span class="c">! 定数定義</span>
<a name="ln-53"></a>  <span class="k">use </span><span class="n">grid_m</span>       <span class="c">! 格子点</span>
<a name="ln-54"></a>  <span class="k">use </span><span class="n">ut_m</span>         <span class="c">! ユーティリティ </span>
<a name="ln-55"></a>  <span class="k">use </span><span class="n">params_m</span>     <span class="c">! パラメータ</span>
<a name="ln-56"></a>  <span class="k">use </span><span class="n">field_m</span>      <span class="c">! 流れ場データ構造体</span>
<a name="ln-57"></a>  <span class="k">use </span><span class="n">debug_m</span>      <span class="c">! デバッグ用</span>
<a name="ln-58"></a>  <span class="k">use </span><span class="n">job_m</span>        <span class="c">! ジョブ管理</span>
<a name="ln-59"></a>  <span class="k">implicit none</span>    <span class="c">! 暗黙の型宣言無効化。必須</span>
<a name="ln-60"></a>
<a name="ln-61"></a>  <span class="k">private</span> <span class="c">! このモジュール内の変数・ルーチン等はデフォルトで非公開</span>
<a name="ln-62"></a>  <span class="k">public</span> <span class="kd">::</span> <span class="n">solver__advance</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-63"></a>            <span class="n">solver__diagnosis</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-64"></a>            <span class="n">solver__get_subfield</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-65"></a>            <span class="n">solver__initialize</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-66"></a>            <span class="n">solver__set_time_step</span>
<a name="ln-67"></a>
<a name="ln-68"></a>  <span class="k">interface </span><span class="n">solver__get_subfield</span>
<a name="ln-69"></a>    <span class="c">!! 流体の基本変数（質量フラックス、質量密度、圧力）</span>
<a name="ln-70"></a>    <span class="c">!! から二次的な量（流れ場、温度場、速度の発散）</span>
<a name="ln-71"></a>    <span class="c">!! を計算するためのルーチン群の多重定義</span>
<a name="ln-72"></a>    <span class="k">module procedure </span><span class="n">subfield_vel</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-73"></a>                     <span class="n">subfield_vel_tm</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-74"></a>                     <span class="n">subfield_vel_tm_divv</span>
<a name="ln-75"></a>  <span class="k">end interface</span>
<a name="ln-76"></a>
<a name="ln-77"></a><span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="nb">GAMMA</span> <span class="o">=</span> <span class="mf">1.4_DR</span>                 <span class="c">! 空気の比熱比</span>
<a name="ln-78"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">GASS_CONST_FOR_AIR</span> <span class="o">=</span> <span class="mf">2.87e2_DR</span> <span class="c">! 空気の気体定数</span>
<a name="ln-79"></a>    <span class="c">!  空気の状態方程式</span>
<a name="ln-80"></a>    <span class="c">!     Pressure = 287 * Mass_density * Temperature</span>
<a name="ln-81"></a>
<a name="ln-82"></a>  <span class="kt">logical</span><span class="p">,</span>  <span class="k">save</span> <span class="kd">::</span> <span class="n">Initialize_done</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>  <span class="c">! モジュール初期化確認フラグ</span>
<a name="ln-83"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">save</span> <span class="kd">::</span> <span class="n">Viscosity</span>                  <span class="c">! 粘性率</span>
<a name="ln-84"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">save</span> <span class="kd">::</span> <span class="n">Gamma1_kappa</span>               <span class="c">! (GAMMA-1)*kappa</span>
<a name="ln-85"></a>                                               <span class="c">! kappaは熱拡散率</span>
<a name="ln-86"></a>  <span class="k">type</span><span class="p">(</span><span class="n">field__vector3d_t</span><span class="p">),</span> <span class="k">save</span> <span class="kd">::</span> <span class="n">Drive_force</span> <span class="c">! 渦輪を駆動する力</span>
<a name="ln-87"></a>
<a name="ln-88"></a>
<a name="ln-89"></a><span class="k">contains</span>
<a name="ln-90"></a>
<a name="ln-91"></a>
<a name="ln-92"></a><span class="k">  function </span><span class="n">drive_force_factor</span><span class="p">(</span><span class="nb">time</span><span class="p">)</span>
<a name="ln-93"></a>    <span class="c">!! 渦輪を駆動する力の時間変化の調整のための係数設定</span>
<a name="ln-94"></a>    <span class="c">!!</span>
<a name="ln-95"></a>    <span class="c">!! @note この係数は0以上1以下。これはassertで確認している。</span>
<a name="ln-96"></a>    <span class="c">!!</span>
<a name="ln-97"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nb">time</span> <span class="c">!! シミュレーション時刻</span>
<a name="ln-98"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">drive_force_factor</span>  <span class="c">!! 力の強さ係数 0から1</span>
<a name="ln-99"></a>    <span class="c">!</span>
<a name="ln-100"></a>    <span class="c">!                                      factor</span>
<a name="ln-101"></a>    <span class="c">!              ___________               |</span>
<a name="ln-102"></a>    <span class="c">!             /|         |\              |</span>
<a name="ln-103"></a>    <span class="c">!      ______/ |         | \______       +--------&gt; time</span>
<a name="ln-104"></a>    <span class="c">!            | |         |  |</span>
<a name="ln-105"></a>    <span class="c">!            | |         |  |</span>
<a name="ln-106"></a>    <span class="c">!            | t0        t1 |</span>
<a name="ln-107"></a>    <span class="c">!          t_start         t_end</span>
<a name="ln-108"></a>    <span class="c">!</span>
<a name="ln-109"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">T_START</span> <span class="o">=</span>  <span class="mf">0.0_DR</span>  <span class="c">! 力をかけ始める時刻</span>
<a name="ln-110"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">T_END</span>   <span class="o">=</span>  <span class="mf">0.01_DR</span> <span class="c">! 力をかけ終わる時刻</span>
<a name="ln-111"></a>                                              <span class="c">! 試行錯誤で調整せよ</span>
<a name="ln-112"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">T0</span> <span class="o">=</span> <span class="n">T_START</span> <span class="o">+</span> <span class="p">(</span><span class="n">T_END</span><span class="o">-</span><span class="n">T_START</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
<a name="ln-113"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">T1</span> <span class="o">=</span> <span class="n">T_END</span>   <span class="o">-</span> <span class="p">(</span><span class="n">T_END</span><span class="o">-</span><span class="n">T_START</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
<a name="ln-114"></a>                                              <span class="c">! 上のコメント図をみよ</span>
<a name="ln-115"></a>                                              <span class="c">! これも試行錯誤で調整せよ</span>
<a name="ln-116"></a>
<a name="ln-117"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ONE</span>  <span class="o">=</span> <span class="mf">1.0_DR</span>  <span class="c">! コードの読みやすさのため定義</span>
<a name="ln-118"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ZERO</span> <span class="o">=</span> <span class="mf">0.0_DR</span>  <span class="c">! コードの読みやすさのため定義</span>
<a name="ln-119"></a>
<a name="ln-120"></a>    <span class="k">call </span><span class="n">ut__assert</span><span class="p">(</span> <span class="n">T_START</span> <span class="o">&lt;</span> <span class="n">T0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">T0</span> <span class="o">&lt;</span> <span class="n">T1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">T1</span> <span class="o">&lt;</span> <span class="n">T_END</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-121"></a>                    <span class="s2">&quot;&lt;solver/drive_force_factor&gt; Time inconsistent.&quot;</span><span class="p">)</span>
<a name="ln-122"></a>      <span class="c">! この関係は以下の前提なのでアサートで確認しておく</span>
<a name="ln-123"></a>
<a name="ln-124"></a>    <span class="c">! 上のコメント図の時間依存係数</span>
<a name="ln-125"></a>    <span class="k">if</span> <span class="p">(</span> <span class="nb">time</span> <span class="o">&lt;=</span> <span class="n">T_START</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-126"></a><span class="k">      </span><span class="n">drive_force_factor</span> <span class="o">=</span> <span class="n">ZERO</span>
<a name="ln-127"></a>    <span class="k">else if</span> <span class="p">(</span> <span class="nb">time</span> <span class="o">&lt;=</span> <span class="n">T0</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-128"></a><span class="k">      </span><span class="n">drive_force_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nb">time</span><span class="o">-</span><span class="n">T_START</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T0</span><span class="o">-</span><span class="n">T_START</span><span class="p">)</span>
<a name="ln-129"></a>    <span class="k">else if</span> <span class="p">(</span> <span class="nb">time</span> <span class="o">&lt;=</span> <span class="n">T1</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-130"></a><span class="k">      </span><span class="n">drive_force_factor</span> <span class="o">=</span> <span class="n">ONE</span>
<a name="ln-131"></a>    <span class="k">else if</span> <span class="p">(</span> <span class="nb">time</span> <span class="o">&lt;=</span> <span class="n">T_END</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-132"></a><span class="k">      </span><span class="n">drive_force_factor</span> <span class="o">=</span> <span class="n">ONE</span> <span class="o">-</span> <span class="p">(</span><span class="nb">time</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_END</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span>
<a name="ln-133"></a>    <span class="k">else</span>
<a name="ln-134"></a><span class="k">      </span><span class="n">drive_force_factor</span> <span class="o">=</span> <span class="n">ZERO</span>
<a name="ln-135"></a>    <span class="k">end if</span>
<a name="ln-136"></a>
<a name="ln-137"></a><span class="k">    call </span><span class="n">ut__assert</span><span class="p">(</span><span class="n">drive_force_factor</span> <span class="o">&gt;=</span><span class="mf">0.0_DR</span>  <span class="p">&amp;</span>
<a name="ln-138"></a>                              <span class="p">.</span><span class="nb">and</span><span class="p">.</span>  <span class="p">&amp;</span>
<a name="ln-139"></a>                    <span class="n">drive_force_factor</span> <span class="o">&lt;=</span><span class="mf">1.0_DR</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-140"></a>                    <span class="s2">&quot;&lt;solver/drive_force_factor&gt; strange value.&quot;</span><span class="p">)</span>
<a name="ln-141"></a>  <span class="k">end function </span><span class="n">drive_force_factor</span>
<a name="ln-142"></a>
<a name="ln-143"></a>
<a name="ln-144"></a>  <span class="k">subroutine </span><span class="n">set_drive_force_field</span>
<a name="ln-145"></a>    <span class="c">!! 渦輪を駆動するための力の場を設定する</span>
<a name="ln-146"></a>    <span class="c">!! その力はシミュレーション開始直後、短い時間だけかける。</span>
<a name="ln-147"></a>    <span class="c">!! 空間的には局在した力を想定している。その形状は円筒形である。</span>
<a name="ln-148"></a>    <span class="c">!! 円筒の軸はx軸上にある。</span>
<a name="ln-149"></a>    <span class="kt">integer</span><span class="p">(</span><span class="n">SI</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-150"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span>
<a name="ln-151"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">force_region_x_min</span><span class="p">,</span> <span class="n">force_region_x_max</span>
<a name="ln-152"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">force_center_y</span><span class="p">,</span> <span class="n">force_center_z</span>
<a name="ln-153"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">force_cylinder_diameter</span><span class="p">,</span> <span class="n">force_cylinder_radius_sq</span>
<a name="ln-154"></a>
<a name="ln-155"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">THE_FORCE</span> <span class="o">=</span> <span class="mf">3.e3_DR</span>
<a name="ln-156"></a>                                     <span class="c">! 瞬間的な力の最大値。</span>
<a name="ln-157"></a>                                     <span class="c">! 試行錯誤で調整せよ。</span>
<a name="ln-158"></a>    <span class="c">!</span>
<a name="ln-159"></a>    <span class="c">!     +--------------------------------------+ ZMAX</span>
<a name="ln-160"></a>    <span class="c">!     |                                      |</span>
<a name="ln-161"></a>    <span class="c">!     |    +-------+                         |</span>
<a name="ln-162"></a>    <span class="c">!     |    | Force |                         |</span>
<a name="ln-163"></a>    <span class="c">!     |    +-------+                         |</span>
<a name="ln-164"></a>    <span class="c">!     |                                      |</span>
<a name="ln-165"></a>    <span class="c">!     +--------------------------------------+ ZMIN</span>
<a name="ln-166"></a>    <span class="c">!    XMIN                                   XMAX</span>
<a name="ln-167"></a>    <span class="c">!</span>
<a name="ln-168"></a>    <span class="n">force_region_x_min</span> <span class="o">=</span> <span class="n">XMIN</span> <span class="o">+</span> <span class="p">(</span><span class="n">XMAX</span><span class="o">-</span><span class="n">XMIN</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span>
<a name="ln-169"></a>      <span class="c">! 力をかける局所円筒領域のx方向の最小値</span>
<a name="ln-170"></a>    <span class="n">force_region_x_max</span> <span class="o">=</span> <span class="n">force_region_x_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">XMAX</span><span class="o">-</span><span class="n">XMIN</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
<a name="ln-171"></a>      <span class="c">! 力をかける局所円筒領域のx方向の最大値</span>
<a name="ln-172"></a>    <span class="n">force_center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">YMAX</span> <span class="o">+</span> <span class="n">YMIN</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<a name="ln-173"></a>      <span class="c">! 力をかける局所円筒領域の中心のy座標を中間にとる</span>
<a name="ln-174"></a>    <span class="n">force_center_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">ZMAX</span> <span class="o">+</span> <span class="n">ZMIN</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<a name="ln-175"></a>      <span class="c">! 力をかける局所円筒領域の中心のz座標を中間にとる</span>
<a name="ln-176"></a>    <span class="n">force_cylinder_diameter</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">YMAX</span><span class="o">-</span><span class="n">YMIN</span><span class="p">,</span> <span class="n">ZMAX</span><span class="o">-</span><span class="n">ZMIN</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
<a name="ln-177"></a>      <span class="c">! 力をかける局所円筒領域の直径</span>
<a name="ln-178"></a>    <span class="n">force_cylinder_radius_sq</span> <span class="o">=</span> <span class="p">(</span><span class="n">force_cylinder_diameter</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-179"></a>      <span class="c">! 力をかける局所円筒領域の半径の2乗</span>
<a name="ln-180"></a>
<a name="ln-181"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">NZ</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-182"></a>      <span class="c">! 境界上の格子点を飛ばして、シミュレーション領域内部</span>
<a name="ln-183"></a>      <span class="c">! を回る3重do loop。境界上の格子点で値は境界条件で設定する。</span>
<a name="ln-184"></a>      <span class="n">zz</span> <span class="o">=</span> <span class="n">grid</span><span class="p">%</span><span class="n">pos</span><span class="p">%</span><span class="n">z</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">force_center_z</span>    <span class="c">! 力の中心からのz方向の距離</span>
<a name="ln-185"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">NY</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-186"></a>        <span class="n">yy</span> <span class="o">=</span> <span class="n">grid</span><span class="p">%</span><span class="n">pos</span><span class="p">%</span><span class="n">y</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="n">force_center_y</span>  <span class="c">! 力の中心からのy方向の距離</span>
<a name="ln-187"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">NX</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-188"></a>          <span class="n">xx</span> <span class="o">=</span> <span class="n">grid</span><span class="p">%</span><span class="n">pos</span><span class="p">%</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                 <span class="c">! これは格子点のx座標そのもの</span>
<a name="ln-189"></a>          <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">zz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">force_cylinder_radius_sq</span>  <span class="p">&amp;</span>
<a name="ln-190"></a>                        <span class="p">.</span><span class="nb">and</span><span class="p">.</span>  <span class="p">&amp;</span>
<a name="ln-191"></a>               <span class="p">(</span><span class="n">xx</span> <span class="o">&gt;</span> <span class="n">force_region_x_min</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-192"></a>                        <span class="p">.</span><span class="nb">and</span><span class="p">.</span>  <span class="p">&amp;</span>
<a name="ln-193"></a>               <span class="p">(</span><span class="n">xx</span> <span class="o">&lt;</span> <span class="n">force_region_x_max</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-194"></a>            <span class="c">! ここで半径そのもので比較するとsqrtの計算が必要になるが</span>
<a name="ln-195"></a>            <span class="c">! このように2乗同士で比較すれば不要。</span>
<a name="ln-196"></a>            <span class="n">Drive_force</span><span class="p">%</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">THE_FORCE</span>  <span class="c">! いまはx方向だけに力がかかる</span>
<a name="ln-197"></a>            <span class="n">Drive_force</span><span class="p">%</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_DR</span>     <span class="c">! としている。斜め方向に力を</span>
<a name="ln-198"></a>            <span class="n">Drive_force</span><span class="p">%</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_DR</span>     <span class="c">! かけるにはこの部分を変更。</span>
<a name="ln-199"></a>          <span class="k">else</span>
<a name="ln-200"></a><span class="k">            </span><span class="n">Drive_force</span><span class="p">%</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_DR</span>
<a name="ln-201"></a>            <span class="n">Drive_force</span><span class="p">%</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_DR</span>
<a name="ln-202"></a>            <span class="n">Drive_force</span><span class="p">%</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_DR</span>
<a name="ln-203"></a>          <span class="k">end if</span>
<a name="ln-204"></a><span class="k">        end do</span>
<a name="ln-205"></a><span class="k">      end do</span>
<a name="ln-206"></a><span class="k">    end do</span>
<a name="ln-207"></a>
<a name="ln-208"></a><span class="k">    call </span><span class="n">field__boundary_condition</span><span class="p">(</span><span class="n">Drive_force</span><span class="p">)</span>
<a name="ln-209"></a>      <span class="c">! 上の3重do loopで設定していない境界上の格子点に力の場を</span>
<a name="ln-210"></a>      <span class="c">! 設定する。周期境界条件。</span>
<a name="ln-211"></a>
<a name="ln-212"></a>    <span class="k">call </span><span class="n">ut__assert</span><span class="p">(</span><span class="nb">maxval</span><span class="p">(</span><span class="n">Drive_force</span><span class="p">%</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="n">THE_FORCE</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-213"></a>                    <span class="s2">&quot;&lt;solver/set_drive_force_field&gt; something is wrong.&quot;</span><span class="p">)</span>
<a name="ln-214"></a>      <span class="c">! 最大値がTHE_FORCEと仮定しているのでそうでなければ何かがおかしい。</span>
<a name="ln-215"></a>
<a name="ln-216"></a>    <span class="k">call </span><span class="n">debug__print</span><span class="p">(</span><span class="s2">&quot;called solver/set_drive_force_field.&quot;</span><span class="p">)</span>
<a name="ln-217"></a>      <span class="c">! デバッグモードがonの時には毎回メッセージを標準出力に</span>
<a name="ln-218"></a>      <span class="c">! 書き出す。コードが完成し、product runの段階に入ったら</span>
<a name="ln-219"></a>      <span class="c">! デバッグモードをoffにすれば、書き出しは抑制される。</span>
<a name="ln-220"></a>      <span class="c">! この行をコメントアウトする必要はない。</span>
<a name="ln-221"></a>  <span class="k">end subroutine </span><span class="n">set_drive_force_field</span>
<a name="ln-222"></a>
<a name="ln-223"></a>
<a name="ln-224"></a>  <span class="k">subroutine </span><span class="n">subfield_vel</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">vel</span><span class="p">)</span>
<a name="ln-225"></a>    <span class="c">!! fluidの基本変数から二次的な場vel（流れの速度ベクトル場）</span>
<a name="ln-226"></a>    <span class="c">!! をもとめる。</span>
<a name="ln-227"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">fluid</span>  <span class="c">!! 流体基本場</span>
<a name="ln-228"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__vector3d_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vel</span>    <span class="c">!! 流れの速度ベクトル</span>
<a name="ln-229"></a>
<a name="ln-230"></a><span class="c">![  vel = fluid%flux / fluid%density     ! operator defined in field.</span>
<a name="ln-231"></a>    <span class="n">vel</span> <span class="o">=</span> <span class="n">operator_vector_divby_scalar</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">,</span> <span class="n">fluid</span><span class="p">%</span><span class="n">density</span><span class="p">)</span>
<a name="ln-232"></a>      <span class="c">! Fortranコンパイラが自己定義演算子（field.f90で定義）</span>
<a name="ln-233"></a>      <span class="c">! を許せば上の簡潔な記述を使うべし。</span>
<a name="ln-234"></a>
<a name="ln-235"></a>    <span class="k">call </span><span class="n">debug__print</span><span class="p">(</span><span class="s2">&quot;called solver/subfield_vel.&quot;</span><span class="p">)</span>
<a name="ln-236"></a>      <span class="c">! デバッグモードがonの時には毎回メッセージを標準出力に</span>
<a name="ln-237"></a>      <span class="c">! 書き出す。コードが完成し、product runの段階に入ったら</span>
<a name="ln-238"></a>      <span class="c">! デバッグモードをoffにすれば、書き出しは抑制される。</span>
<a name="ln-239"></a>      <span class="c">! この行をコメントアウトする必要はない。</span>
<a name="ln-240"></a>  <span class="k">end subroutine </span><span class="n">subfield_vel</span>
<a name="ln-241"></a>
<a name="ln-242"></a>
<a name="ln-243"></a>  <span class="k">subroutine </span><span class="n">subfield_vel_tm</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="n">tm</span><span class="p">)</span>
<a name="ln-244"></a>    <span class="c">!! fluidの基本変数から二次的な場（速度ベクトル場velと温度場tm）</span>
<a name="ln-245"></a>    <span class="c">!! をもとめる。</span>
<a name="ln-246"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">),</span>          <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">fluid</span> <span class="c">!! 流体基本場</span>
<a name="ln-247"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__vector3d_t</span><span class="p">),</span>       <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vel</span>   <span class="c">!! 流れ場</span>
<a name="ln-248"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tm</span>    <span class="c">!! 温度場</span>
<a name="ln-249"></a>
<a name="ln-250"></a><span class="c">![   vel = fluid%flux / fluid%density ! operator defined in field.f90.</span>
<a name="ln-251"></a>     <span class="n">vel</span> <span class="o">=</span> <span class="n">operator_vector_divby_scalar</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">,</span> <span class="n">fluid</span><span class="p">%</span><span class="n">density</span><span class="p">)</span>
<a name="ln-252"></a>      <span class="n">tm</span> <span class="o">=</span> <span class="n">fluid</span><span class="p">%</span><span class="n">pressure</span> <span class="o">/</span> <span class="p">(</span><span class="n">GASS_CONST_FOR_AIR</span><span class="o">*</span><span class="n">fluid</span><span class="p">%</span><span class="n">density</span><span class="p">)</span>
<a name="ln-253"></a>       <span class="c">! Fortranコンパイラが自己定義演算子（field.f90で定義）</span>
<a name="ln-254"></a>       <span class="c">! を許せば上の簡潔な記述を使うべし。</span>
<a name="ln-255"></a>
<a name="ln-256"></a>    <span class="k">call </span><span class="n">debug__print</span><span class="p">(</span><span class="s2">&quot;called solver/subfield_vel_tm.&quot;</span><span class="p">)</span>
<a name="ln-257"></a>  <span class="k">end subroutine </span><span class="n">subfield_vel_tm</span>
<a name="ln-258"></a>
<a name="ln-259"></a>
<a name="ln-260"></a>  <span class="k">subroutine </span><span class="n">subfield_vel_tm_divv</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="n">tm</span><span class="p">,</span><span class="n">divv</span><span class="p">)</span>
<a name="ln-261"></a>    <span class="c">!! fluidの基本変数から二次的な場（速度ベクトル場velと</span>
<a name="ln-262"></a>    <span class="c">!! 温度場tmと速度の発散divv）をもとめる。</span>
<a name="ln-263"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">),</span>          <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">fluid</span>  <span class="c">!! 流体基本場</span>
<a name="ln-264"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__vector3d_t</span><span class="p">),</span>       <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vel</span>    <span class="c">!! 流れ場</span>
<a name="ln-265"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tm</span>     <span class="c">!! 温度場</span>
<a name="ln-266"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">divv</span>   <span class="c">!! 流れの発散</span>
<a name="ln-267"></a>
<a name="ln-268"></a><span class="c">![   vel = fluid%flux     / fluid%density ! operator defined in field.f90.</span>
<a name="ln-269"></a>     <span class="n">vel</span> <span class="o">=</span> <span class="n">operator_vector_divby_scalar</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">,</span> <span class="n">fluid</span><span class="p">%</span><span class="n">density</span><span class="p">)</span>
<a name="ln-270"></a>      <span class="n">tm</span> <span class="o">=</span> <span class="n">fluid</span><span class="p">%</span><span class="n">pressure</span> <span class="o">/</span> <span class="n">fluid</span><span class="p">%</span><span class="n">density</span>
<a name="ln-271"></a><span class="c">![  divv = .div.vel</span>
<a name="ln-272"></a>    <span class="n">divv</span> <span class="o">=</span> <span class="n">operator_div</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span>
<a name="ln-273"></a>       <span class="c">! Fortranコンパイラが自己定義演算子（field.f90で定義）</span>
<a name="ln-274"></a>       <span class="c">! を許せば上の簡潔な記述を使うべし。</span>
<a name="ln-275"></a>
<a name="ln-276"></a>    <span class="k">call </span><span class="n">debug__print</span><span class="p">(</span><span class="s2">&quot;called solver/subfield_vel_tm_divv.&quot;</span><span class="p">)</span>
<a name="ln-277"></a>  <span class="k">end subroutine </span><span class="n">subfield_vel_tm_divv</span>
<a name="ln-278"></a>
<a name="ln-279"></a>
<a name="ln-280"></a>  <span class="k">function </span><span class="n">the_equation</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">,</span><span class="n">vz</span><span class="p">,</span><span class="n">tm</span><span class="p">,</span><span class="n">divv</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="n">fy</span><span class="p">,</span><span class="n">fz</span><span class="p">,</span><span class="n">ps</span><span class="p">)</span>
<a name="ln-281"></a>    <span class="c">!! ナビエ・ストークス方程式の右辺（時間変化量）dtを掛けたものを計算</span>
<a name="ln-282"></a>    <span class="c">!!</span>
<a name="ln-283"></a>    <span class="c">!! @note</span>
<a name="ln-284"></a>    <span class="c">!!    粘性による加熱の効果は小さいので無視している。</span>
<a name="ln-285"></a>    <span class="c">!!    この項を入れる場合は圧力の方程式</span>
<a name="ln-286"></a>    <span class="c">!!    the_equation%pressure に追加すればよい。</span>
<a name="ln-287"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span>                      <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span>      <span class="c">!! 時刻と時間刻み幅</span>
<a name="ln-288"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="c">!! 速度3成分</span>
<a name="ln-289"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tm</span><span class="p">,</span> <span class="n">divv</span>   <span class="c">!! 温度と速度の発散</span>
<a name="ln-290"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span> <span class="c">!! 質量フラックス</span>
<a name="ln-291"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ps</span>         <span class="c">!! 圧力</span>
<a name="ln-292"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">)</span> <span class="kd">::</span> <span class="n">the_equation</span>  <span class="c">!! 時間刻みdtでの流体データの微小変化量</span>
<a name="ln-293"></a>
<a name="ln-294"></a>    <span class="kt">integer</span><span class="p">(</span><span class="n">SI</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-295"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ONE_THIRD</span> <span class="o">=</span> <span class="mf">1.0_DR</span> <span class="o">/</span> <span class="mf">3.0_DR</span>  <span class="c">! 演算回数節約のため</span>
<a name="ln-296"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gradpx</span><span class="p">,</span> <span class="n">gradpy</span><span class="p">,</span> <span class="n">gradpz</span>     <span class="c">! 圧力の勾配 (gradient p)</span>
<a name="ln-297"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gdivvx</span><span class="p">,</span> <span class="n">gdivvy</span><span class="p">,</span> <span class="n">gdivvz</span>     <span class="c">! 速度の発散の勾配</span>
<a name="ln-298"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">divfvx</span><span class="p">,</span> <span class="n">divfvy</span><span class="p">,</span> <span class="n">divfvz</span>     <span class="c">! 速度・密度フラックステンソルの発散</span>
<a name="ln-299"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lapvx</span><span class="p">,</span> <span class="n">lapvy</span><span class="p">,</span> <span class="n">lapvz</span><span class="p">,</span> <span class="n">laptm</span> <span class="c">! 速度と温度のラプラシアン</span>
<a name="ln-300"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">divf</span>                       <span class="c">! 質量フラックスの発散</span>
<a name="ln-301"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">factor</span>                     <span class="c">! 渦輪駆動力の係数（時間依存）</span>
<a name="ln-302"></a>
<a name="ln-303"></a>    <span class="k">call </span><span class="n">ut__assert</span><span class="p">(</span><span class="n">Initialize_done</span><span class="p">,</span> <span class="s2">&quot;&lt;solver/the_equation&gt; Forgot init?&quot;</span><span class="p">)</span>
<a name="ln-304"></a>      <span class="c">! 初期化忘れしていないか確認</span>
<a name="ln-305"></a>
<a name="ln-306"></a>    <span class="n">factor</span> <span class="o">=</span> <span class="n">drive_force_factor</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<a name="ln-307"></a>      <span class="c">! 渦輪の駆動力はシミュレーション開始直後だけかける。</span>
<a name="ln-308"></a>      <span class="c">! その後は何も力をかけない（渦輪が自然に発生し、リング上の</span>
<a name="ln-309"></a>      <span class="c">! 構造が移動していく。）つまりこのfactorはシミュレーション</span>
<a name="ln-310"></a>      <span class="c">! 開始直後だけ非ゼロで、残りの殆どの時間はゼロが入っている。</span>
<a name="ln-311"></a>
<a name="ln-312"></a>    <span class="c">! 以下のdo loopがこのシミュレーションで最も時間のかかる</span>
<a name="ln-313"></a>    <span class="c">! 部分である。したがってここでは.div.などのユーザ定義</span>
<a name="ln-314"></a>    <span class="c">! 演算子は（コンパイラがその使用を許したとしても）あえて</span>
<a name="ln-315"></a>    <span class="c">! 使わず、泥臭く書いている。これは将来、</span>
<a name="ln-316"></a>    <span class="c">! 速度向上のためにコードの最適化をしたり、</span>
<a name="ln-317"></a>    <span class="c">! OpenMP化することを見越してのことである。</span>
<a name="ln-318"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">NZ</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-319"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">NY</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-320"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">NX</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-321"></a>          <span class="c">! 以下のコメントでは  </span>
<a name="ln-322"></a>          <span class="c">! P 圧力</span>
<a name="ln-323"></a>          <span class="c">! V 速度場ベクトル</span>
<a name="ln-324"></a>          <span class="c">! F 質量フラックスベクトル</span>
<a name="ln-325"></a>          <span class="c">! T 温度</span>
<a name="ln-326"></a>
<a name="ln-327"></a>          <span class="c">! grad P</span>
<a name="ln-328"></a>          <span class="n">gradpx</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ps</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">ps</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">x</span>
<a name="ln-329"></a>          <span class="n">gradpy</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">ps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">y</span>
<a name="ln-330"></a>          <span class="n">gradpz</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">ps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">z</span>
<a name="ln-331"></a>
<a name="ln-332"></a>          <span class="c">! grad (div V) の3成分</span>
<a name="ln-333"></a>          <span class="n">gdivvx</span> <span class="o">=</span> <span class="p">(</span> <span class="n">divv</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">divv</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">x</span>
<a name="ln-334"></a>          <span class="n">gdivvy</span> <span class="o">=</span> <span class="p">(</span> <span class="n">divv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">divv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">y</span>
<a name="ln-335"></a>          <span class="n">gdivvz</span> <span class="o">=</span> <span class="p">(</span> <span class="n">divv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">divv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">z</span>
<a name="ln-336"></a>
<a name="ln-337"></a>          <span class="c">! VFテンソルの発散 div(VF) の3成分</span>
<a name="ln-338"></a>          <span class="n">divfvx</span> <span class="o">=</span> <span class="p">(</span> <span class="n">fx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-339"></a>                    <span class="o">-</span><span class="n">fx</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">x</span>  <span class="p">&amp;</span>
<a name="ln-340"></a>                 <span class="o">+</span> <span class="p">(</span> <span class="n">fx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-341"></a>                    <span class="o">-</span><span class="n">fx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">y</span>  <span class="p">&amp;</span>
<a name="ln-342"></a>                 <span class="o">+</span> <span class="p">(</span> <span class="n">fx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-343"></a>                    <span class="o">-</span><span class="n">fx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">z</span>
<a name="ln-344"></a>          <span class="n">divfvy</span> <span class="o">=</span> <span class="p">(</span> <span class="n">fy</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-345"></a>                    <span class="o">-</span><span class="n">fy</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">x</span>  <span class="p">&amp;</span>
<a name="ln-346"></a>                 <span class="o">+</span> <span class="p">(</span> <span class="n">fy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-347"></a>                    <span class="o">-</span><span class="n">fy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">y</span>  <span class="p">&amp;</span>
<a name="ln-348"></a>                 <span class="o">+</span> <span class="p">(</span> <span class="n">fy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-349"></a>                    <span class="o">-</span><span class="n">fy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">z</span>
<a name="ln-350"></a>          <span class="n">divfvz</span> <span class="o">=</span> <span class="p">(</span> <span class="n">fz</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-351"></a>                    <span class="o">-</span><span class="n">fz</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">x</span>  <span class="p">&amp;</span>
<a name="ln-352"></a>                 <span class="o">+</span> <span class="p">(</span> <span class="n">fz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-353"></a>                    <span class="o">-</span><span class="n">fz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">y</span>  <span class="p">&amp;</span>
<a name="ln-354"></a>                 <span class="o">+</span> <span class="p">(</span> <span class="n">fz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-355"></a>                    <span class="o">-</span><span class="n">fz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">z</span>
<a name="ln-356"></a>
<a name="ln-357"></a>          <span class="c">! Laplacin V の3成分</span>
<a name="ln-358"></a>          <span class="n">lapvx</span> <span class="o">=</span> <span class="p">(</span> <span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">x</span> <span class="p">&amp;</span>
<a name="ln-359"></a>                <span class="o">+</span> <span class="p">(</span> <span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">y</span> <span class="p">&amp;</span>
<a name="ln-360"></a>                <span class="o">+</span> <span class="p">(</span> <span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">z</span>
<a name="ln-361"></a>          <span class="n">lapvy</span> <span class="o">=</span> <span class="p">(</span> <span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">x</span> <span class="p">&amp;</span>
<a name="ln-362"></a>                <span class="o">+</span> <span class="p">(</span> <span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">y</span> <span class="p">&amp;</span>
<a name="ln-363"></a>                <span class="o">+</span> <span class="p">(</span> <span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">z</span>
<a name="ln-364"></a>          <span class="n">lapvz</span> <span class="o">=</span> <span class="p">(</span> <span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">x</span> <span class="p">&amp;</span>
<a name="ln-365"></a>                <span class="o">+</span> <span class="p">(</span> <span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">y</span> <span class="p">&amp;</span>
<a name="ln-366"></a>                <span class="o">+</span> <span class="p">(</span> <span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">z</span>
<a name="ln-367"></a>
<a name="ln-368"></a>          <span class="c">! Laplacin T </span>
<a name="ln-369"></a>          <span class="n">laptm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">x</span> <span class="p">&amp;</span>
<a name="ln-370"></a>                <span class="o">+</span> <span class="p">(</span> <span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">y</span> <span class="p">&amp;</span>
<a name="ln-371"></a>                <span class="o">+</span> <span class="p">(</span> <span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">tm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">d2</span><span class="p">%</span><span class="n">z</span>
<a name="ln-372"></a>
<a name="ln-373"></a>          <span class="c">! div F </span>
<a name="ln-374"></a>          <span class="n">divf</span> <span class="o">=</span> <span class="p">(</span> <span class="n">fx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">fx</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">x</span>  <span class="p">&amp;</span>
<a name="ln-375"></a>               <span class="o">+</span> <span class="p">(</span> <span class="n">fy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">fy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">y</span>  <span class="p">&amp;</span>
<a name="ln-376"></a>               <span class="o">+</span> <span class="p">(</span> <span class="n">fz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">fz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="p">%</span><span class="n">d1</span><span class="p">%</span><span class="n">z</span>
<a name="ln-377"></a>
<a name="ln-378"></a>          <span class="c">! 以下がナビエ・ストークス方程式</span>
<a name="ln-379"></a>
<a name="ln-380"></a>          <span class="c">!  密度の時間発展</span>
<a name="ln-381"></a>          <span class="n">the_equation</span><span class="p">%</span><span class="n">density</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">divf</span><span class="o">*</span><span class="n">dt</span>
<a name="ln-382"></a>
<a name="ln-383"></a>          <span class="c">!  質量フラックスの時間発展（3成分）</span>
<a name="ln-384"></a>          <span class="n">the_equation</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="p">&amp;</span>
<a name="ln-385"></a>               <span class="p">(</span> <span class="o">-</span> <span class="n">divfvx</span>  <span class="p">&amp;</span>
<a name="ln-386"></a>                 <span class="o">-</span> <span class="n">gradpx</span>  <span class="p">&amp;</span>
<a name="ln-387"></a>                 <span class="o">+</span> <span class="n">Drive_force</span><span class="p">%</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span>  <span class="p">&amp;</span>
<a name="ln-388"></a>                 <span class="o">+</span> <span class="n">Viscosity</span> <span class="o">*</span> <span class="p">(</span> <span class="n">lapvx</span> <span class="o">+</span> <span class="n">ONE_THIRD</span><span class="o">*</span><span class="n">gdivvx</span> <span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-389"></a>               <span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
<a name="ln-390"></a>          <span class="n">the_equation</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="p">&amp;</span>
<a name="ln-391"></a>               <span class="p">(</span> <span class="o">-</span> <span class="n">divfvy</span>  <span class="p">&amp;</span>
<a name="ln-392"></a>                 <span class="o">-</span> <span class="n">gradpy</span>  <span class="p">&amp;</span>
<a name="ln-393"></a>                 <span class="o">+</span> <span class="n">Drive_force</span><span class="p">%</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span>  <span class="p">&amp;</span>
<a name="ln-394"></a>                 <span class="o">+</span> <span class="n">Viscosity</span> <span class="o">*</span> <span class="p">(</span> <span class="n">lapvy</span> <span class="o">+</span> <span class="n">ONE_THIRD</span><span class="o">*</span><span class="n">gdivvy</span> <span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-395"></a>               <span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
<a name="ln-396"></a>          <span class="n">the_equation</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="p">&amp;</span>
<a name="ln-397"></a>               <span class="p">(</span> <span class="o">-</span> <span class="n">divfvz</span>  <span class="p">&amp;</span>
<a name="ln-398"></a>                 <span class="o">-</span> <span class="n">gradpz</span>  <span class="p">&amp;</span>
<a name="ln-399"></a>                 <span class="o">+</span> <span class="n">Drive_force</span><span class="p">%</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span>  <span class="p">&amp;</span>
<a name="ln-400"></a>                 <span class="o">+</span> <span class="n">Viscosity</span> <span class="o">*</span> <span class="p">(</span> <span class="n">lapvz</span> <span class="o">+</span> <span class="n">ONE_THIRD</span><span class="o">*</span><span class="n">gdivvz</span> <span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-401"></a>               <span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
<a name="ln-402"></a>
<a name="ln-403"></a>          <span class="c">!  圧力の時間発展</span>
<a name="ln-404"></a>          <span class="n">the_equation</span><span class="p">%</span><span class="n">pressure</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="p">&amp;</span>
<a name="ln-405"></a>              <span class="p">(</span> <span class="o">-</span> <span class="p">(</span> <span class="n">vx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradpx</span>  <span class="p">&amp;</span>
<a name="ln-406"></a>                  <span class="o">+</span> <span class="n">vy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradpy</span>  <span class="p">&amp;</span>
<a name="ln-407"></a>                  <span class="o">+</span> <span class="n">vz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradpz</span>  <span class="p">&amp;</span>
<a name="ln-408"></a>                  <span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-409"></a>                <span class="o">+</span> <span class="n">Gamma1_kappa</span> <span class="o">*</span> <span class="n">laptm</span>  <span class="p">&amp;</span>
<a name="ln-410"></a>                <span class="o">-</span> <span class="nb">GAMMA</span> <span class="o">*</span> <span class="n">ps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">divv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-411"></a>              <span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
<a name="ln-412"></a>        <span class="k">end do</span>
<a name="ln-413"></a><span class="k">      end do</span>
<a name="ln-414"></a><span class="k">    end do</span>
<a name="ln-415"></a>
<a name="ln-416"></a><span class="k">    call </span><span class="n">field__boundary_condition</span><span class="p">(</span><span class="n">the_equation</span><span class="p">)</span>
<a name="ln-417"></a>      <span class="c">! 境界条件の設定（周期境界条件）</span>
<a name="ln-418"></a>      <span class="c">! 上のdo loopは境界面上の格子点を除いた格子点（シミュレーション</span>
<a name="ln-419"></a>      <span class="c">! 領域の内部の格子点）上での値を計算するものであった。</span>
<a name="ln-420"></a>      <span class="c">! ここで境界面上の格子点の値の（更新されたばかりの）内部の</span>
<a name="ln-421"></a>      <span class="c">! 格子点上のデータをコピーすることで設定する。</span>
<a name="ln-422"></a>    <span class="k">call </span><span class="n">debug__print</span><span class="p">(</span><span class="s2">&quot;called solver/the_equation.&quot;</span><span class="p">)</span>
<a name="ln-423"></a>      <span class="c">! デバッグモードがonの時には毎回メッセージを標準出力に</span>
<a name="ln-424"></a>      <span class="c">! 書き出す。コードが完成し、product runの段階に入ったら</span>
<a name="ln-425"></a>      <span class="c">! デバッグモードをoffにすれば、書き出しは抑制される。</span>
<a name="ln-426"></a>      <span class="c">! この行をコメントアウトする必要はない。</span>
<a name="ln-427"></a>  <span class="k">end function </span><span class="n">the_equation</span>
<a name="ln-428"></a>
<a name="ln-429"></a>
<a name="ln-430"></a><span class="c">!</span>
<a name="ln-431"></a><span class="c">! Private  これより上が非公開の関数・ルーチン</span>
<a name="ln-432"></a><span class="c">!===================================================</span>
<a name="ln-433"></a><span class="c">! Public   これより下が公開する関数・ルーチン</span>
<a name="ln-434"></a><span class="c">!</span>
<a name="ln-435"></a>
<a name="ln-436"></a>
<a name="ln-437"></a>  <span class="k">subroutine </span><span class="n">solver__advance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">fluid</span><span class="p">)</span>
<a name="ln-438"></a>    <span class="c">!! 4段4次ルンゲ・クッタ積分法による時間積分の実行</span>
<a name="ln-439"></a>    <span class="c">!!</span>
<a name="ln-440"></a>    <span class="c">!! @note</span>
<a name="ln-441"></a>    <span class="c">!!   ここでは教科書に書かれている古典的な4段4次の</span>
<a name="ln-442"></a>    <span class="c">!!   ルンゲ・クッタ積分法をそのまま実装している。</span>
<a name="ln-443"></a>    <span class="c">!!   作業用の構造体を5つ使用している（dfluid01からdfluid04とgluid）</span>
<a name="ln-444"></a>    <span class="c">!!   これらの作業変数の数を減らし、メモリを節約にするためには</span>
<a name="ln-445"></a>    <span class="c">!!   Runge-Kutta-Gill法などの方法がある。</span>
<a name="ln-446"></a>    <span class="c">!!</span>
<a name="ln-447"></a>    <span class="c">!! @note</span>
<a name="ln-448"></a>    <span class="c">!!   速度（vel）、温度（tm）, 速度の発散（divv）などの配列などは</span>
<a name="ln-449"></a>    <span class="c">!!   このスキームでは基本変数から毎回計算すべき一種の作業配列である。</span>
<a name="ln-450"></a>    <span class="c">!!   したがって、このモジュール内の他の場所（サブルーチン・関数）でも</span>
<a name="ln-451"></a>    <span class="c">!!   これらの変数（3次元の大きな配列）を宣言・使用している。</span>
<a name="ln-452"></a>    <span class="c">!!   使用メモリを節約するためにはこれらの作業配列は共通のものを</span>
<a name="ln-453"></a>    <span class="c">!!   一つづつ用意するというのも可能である。しかし、そうするとコードが</span>
<a name="ln-454"></a>    <span class="c">!!   読みにくくなるであろう。</span>
<a name="ln-455"></a>
<a name="ln-456"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t</span>  <span class="c">!! 時刻</span>
<a name="ln-457"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dt</span> <span class="c">!! 時間刻み幅</span>
<a name="ln-458"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">fluid</span> <span class="c">!! 流体データ</span>
<a name="ln-459"></a>
<a name="ln-460"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ONE_SIXTH</span> <span class="o">=</span> <span class="mf">1.0_DR</span> <span class="o">/</span> <span class="mf">6.0_DR</span> <span class="c">! 演算数節約の</span>
<a name="ln-461"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ONE_THIRD</span> <span class="o">=</span> <span class="mf">1.0_DR</span> <span class="o">/</span> <span class="mf">3.0_DR</span> <span class="c">! ために定義</span>
<a name="ln-462"></a>
<a name="ln-463"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__vector3d_t</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">vel</span>   <span class="c">! 速度場</span>
<a name="ln-464"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tm</span>    <span class="c">! 温度場</span>
<a name="ln-465"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">)</span> <span class="kd">::</span> <span class="n">divv</span>  <span class="c">! 速度場の発散</span>
<a name="ln-466"></a>
<a name="ln-467"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dfluid01</span><span class="p">,</span> <span class="n">dfluid02</span><span class="p">,</span> <span class="n">dfluid03</span><span class="p">,</span> <span class="n">dfluid04</span>
<a name="ln-468"></a>      <span class="c">! 古典的な4段4次ルンゲ・クッタ積分法に必要な4つの作業配列</span>
<a name="ln-469"></a>      <span class="c">! サイズが大きいことに注意。</span>
<a name="ln-470"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gluid</span>  <span class="c">! work variable</span>
<a name="ln-471"></a>      <span class="c">! さらにもう一つの作業配列</span>
<a name="ln-472"></a>      <span class="c">! サイズが大きいことに注意。</span>
<a name="ln-473"></a>
<a name="ln-474"></a>
<a name="ln-475"></a>    <span class="c">!---ルンゲ・クッタの第1段---!</span>
<a name="ln-476"></a>    <span class="k">call </span><span class="n">subfield_vel_tm_divv</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="n">tm</span><span class="p">,</span><span class="n">divv</span><span class="p">)</span>
<a name="ln-477"></a>      <span class="c">! 基本変数から副次的変数である速度、温度、速度の発散を求める</span>
<a name="ln-478"></a>    <span class="n">dfluid01</span> <span class="o">=</span> <span class="n">the_equation</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-479"></a>                            <span class="n">vel</span><span class="p">%</span><span class="n">x</span><span class="p">,</span> <span class="n">vel</span><span class="p">%</span><span class="n">y</span><span class="p">,</span> <span class="n">vel</span><span class="p">%</span><span class="n">z</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">divv</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-480"></a>                            <span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">x</span><span class="p">,</span> <span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">y</span><span class="p">,</span> <span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">z</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-481"></a>                            <span class="n">fluid</span><span class="p">%</span><span class="n">pressure</span><span class="p">)</span>
<a name="ln-482"></a>
<a name="ln-483"></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-484"></a>      <span class="c">! 渦輪を駆動する力は時刻（t）の関数として設定しているので、</span>
<a name="ln-485"></a>      <span class="c">! いま解いているナビエ・ストークス方程式は時間に陽に依存する。</span>
<a name="ln-486"></a>
<a name="ln-487"></a>    <span class="c">!---ルンゲ・クッタの第2段---!</span>
<a name="ln-488"></a><span class="c">![  gluid = fluid + dfluid01*0.5_DR</span>
<a name="ln-489"></a>    <span class="n">dfluid01</span> <span class="o">=</span> <span class="n">operator_fluid_times_real</span><span class="p">(</span><span class="n">dfluid01</span><span class="p">,</span><span class="mf">0.5_DR</span><span class="p">)</span>
<a name="ln-490"></a>    <span class="n">gluid</span>    <span class="o">=</span> <span class="n">operator_fluid_add</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">dfluid01</span><span class="p">)</span>
<a name="ln-491"></a>      <span class="c">! Fortranコンパイラが自己定義演算子をきちんと処理できる</span>
<a name="ln-492"></a>      <span class="c">! 場合は上の簡潔な記述の方が（読みやすいので）好ましい。</span>
<a name="ln-493"></a>
<a name="ln-494"></a>    <span class="k">call </span><span class="n">subfield_vel_tm_divv</span><span class="p">(</span><span class="n">gluid</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="n">tm</span><span class="p">,</span><span class="n">divv</span><span class="p">)</span>
<a name="ln-495"></a>    <span class="n">dfluid02</span> <span class="o">=</span> <span class="n">the_equation</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-496"></a>                            <span class="n">vel</span><span class="p">%</span><span class="n">x</span><span class="p">,</span> <span class="n">vel</span><span class="p">%</span><span class="n">y</span><span class="p">,</span> <span class="n">vel</span><span class="p">%</span><span class="n">z</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">divv</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-497"></a>                            <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">x</span><span class="p">,</span> <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">y</span><span class="p">,</span> <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">z</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-498"></a>                            <span class="n">gluid</span><span class="p">%</span><span class="n">pressure</span><span class="p">)</span>
<a name="ln-499"></a>
<a name="ln-500"></a>    <span class="c">!---ルンゲ・クッタの第3段---!</span>
<a name="ln-501"></a><span class="c">![  gluid = fluid + dfluid02*0.5_DR</span>
<a name="ln-502"></a>    <span class="n">dfluid02</span> <span class="o">=</span> <span class="n">operator_fluid_times_real</span><span class="p">(</span><span class="n">dfluid02</span><span class="p">,</span><span class="mf">0.5_DR</span><span class="p">)</span>
<a name="ln-503"></a>    <span class="n">gluid</span>    <span class="o">=</span> <span class="n">operator_fluid_add</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">dfluid02</span><span class="p">)</span>
<a name="ln-504"></a>      <span class="c">! Fortranコンパイラが自己定義演算子をきちんと処理できる</span>
<a name="ln-505"></a>      <span class="c">! 場合は上の簡潔な記述の方が（読みやすいので）好ましい。</span>
<a name="ln-506"></a>
<a name="ln-507"></a>    <span class="k">call </span><span class="n">subfield_vel_tm_divv</span><span class="p">(</span><span class="n">gluid</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="n">tm</span><span class="p">,</span><span class="n">divv</span><span class="p">)</span>
<a name="ln-508"></a>    <span class="n">dfluid03</span> <span class="o">=</span> <span class="n">the_equation</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-509"></a>                            <span class="n">vel</span><span class="p">%</span><span class="n">x</span><span class="p">,</span> <span class="n">vel</span><span class="p">%</span><span class="n">y</span><span class="p">,</span> <span class="n">vel</span><span class="p">%</span><span class="n">z</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">divv</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-510"></a>                            <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">x</span><span class="p">,</span> <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">y</span><span class="p">,</span> <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">z</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-511"></a>                            <span class="n">gluid</span><span class="p">%</span><span class="n">pressure</span><span class="p">)</span>
<a name="ln-512"></a>
<a name="ln-513"></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-514"></a>      <span class="c">! 繰り返すが、渦輪を駆動する力は時刻（t）の関数として設定しているので、</span>
<a name="ln-515"></a>      <span class="c">! いま解いているナビエ・ストークス方程式は時間に陽に依存する。</span>
<a name="ln-516"></a>
<a name="ln-517"></a>    <span class="c">!---ルンゲ・クッタの第4段---!</span>
<a name="ln-518"></a><span class="c">![  gluid = fluid + dfluid03</span>
<a name="ln-519"></a>    <span class="n">gluid</span> <span class="o">=</span> <span class="n">operator_fluid_add</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">dfluid03</span><span class="p">)</span>
<a name="ln-520"></a>      <span class="c">! Fortranコンパイラが自己定義演算子をきちんと処理できる</span>
<a name="ln-521"></a>      <span class="c">! 場合は上の簡潔な記述の方が（読みやすいので）好ましい。</span>
<a name="ln-522"></a>
<a name="ln-523"></a>    <span class="k">call </span><span class="n">subfield_vel_tm_divv</span><span class="p">(</span><span class="n">gluid</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="n">tm</span><span class="p">,</span><span class="n">divv</span><span class="p">)</span>
<a name="ln-524"></a>    <span class="n">dfluid04</span> <span class="o">=</span> <span class="n">the_equation</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-525"></a>                            <span class="n">vel</span><span class="p">%</span><span class="n">x</span><span class="p">,</span> <span class="n">vel</span><span class="p">%</span><span class="n">y</span><span class="p">,</span> <span class="n">vel</span><span class="p">%</span><span class="n">z</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">divv</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-526"></a>                            <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">x</span><span class="p">,</span> <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">y</span><span class="p">,</span> <span class="n">gluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">z</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-527"></a>                            <span class="n">gluid</span><span class="p">%</span><span class="n">pressure</span><span class="p">)</span>
<a name="ln-528"></a>
<a name="ln-529"></a>    <span class="c">!--- 最終結果 ---!</span>
<a name="ln-530"></a>
<a name="ln-531"></a><span class="c">![  fluid = fluid  &amp;</span>
<a name="ln-532"></a><span class="c">![        + ONE_SIXTH*( dfluid01 + 2*dfluid02 + 2*dfluid03 + dfluid04 )</span>
<a name="ln-533"></a>    <span class="n">dfluid01</span> <span class="o">=</span> <span class="n">operator_fluid_times_real</span><span class="p">(</span><span class="n">dfluid01</span><span class="p">,</span><span class="n">ONE_SIXTH</span><span class="p">)</span>
<a name="ln-534"></a>    <span class="n">dfluid02</span> <span class="o">=</span> <span class="n">operator_fluid_times_real</span><span class="p">(</span><span class="n">dfluid02</span><span class="p">,</span><span class="n">ONE_THIRD</span><span class="p">)</span>
<a name="ln-535"></a>    <span class="n">dfluid03</span> <span class="o">=</span> <span class="n">operator_fluid_times_real</span><span class="p">(</span><span class="n">dfluid03</span><span class="p">,</span><span class="n">ONE_THIRD</span><span class="p">)</span>
<a name="ln-536"></a>    <span class="n">dfluid04</span> <span class="o">=</span> <span class="n">operator_fluid_times_real</span><span class="p">(</span><span class="n">dfluid04</span><span class="p">,</span><span class="n">ONE_SIXTH</span><span class="p">)</span>
<a name="ln-537"></a>    <span class="n">fluid</span> <span class="o">=</span> <span class="n">operator_fluid_add</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">dfluid01</span><span class="p">)</span>
<a name="ln-538"></a>    <span class="n">fluid</span> <span class="o">=</span> <span class="n">operator_fluid_add</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">dfluid02</span><span class="p">)</span>
<a name="ln-539"></a>    <span class="n">fluid</span> <span class="o">=</span> <span class="n">operator_fluid_add</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">dfluid03</span><span class="p">)</span>
<a name="ln-540"></a>    <span class="n">fluid</span> <span class="o">=</span> <span class="n">operator_fluid_add</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">dfluid04</span><span class="p">)</span>
<a name="ln-541"></a>      <span class="c">! Fortranコンパイラが自己定義演算子をきちんと処理できる</span>
<a name="ln-542"></a>      <span class="c">! 場合は一番上の簡潔な記述の方が（読みやすいので）好ましい。</span>
<a name="ln-543"></a>
<a name="ln-544"></a>    <span class="k">call </span><span class="n">debug__print</span><span class="p">(</span><span class="s2">&quot;called solver__advance.&quot;</span><span class="p">)</span>
<a name="ln-545"></a>      <span class="c">! デバッグモードがonの時には毎回メッセージを標準出力に</span>
<a name="ln-546"></a>      <span class="c">! 書き出す。コードが完成し、product runの段階に入ったら</span>
<a name="ln-547"></a>      <span class="c">! デバッグモードをoffにすれば、書き出しは抑制される。</span>
<a name="ln-548"></a>      <span class="c">! この行をコメントアウトする必要はない。</span>
<a name="ln-549"></a>  <span class="k">end subroutine </span><span class="n">solver__advance</span>
<a name="ln-550"></a>
<a name="ln-551"></a>
<a name="ln-552"></a>  <span class="k">subroutine </span><span class="n">solver__diagnosis</span><span class="p">(</span><span class="n">nloop</span><span class="p">,</span><span class="nb">time</span><span class="p">,</span><span class="n">fluid</span><span class="p">)</span>
<a name="ln-553"></a>    <span class="c">!! 流体の「健康状態」を診断する</span>
<a name="ln-554"></a>    <span class="kt">integer</span><span class="p">(</span><span class="n">DI</span><span class="p">),</span>          <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nloop</span>  <span class="c">!! ループカウンタ</span>
<a name="ln-555"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span>             <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nb">time</span>   <span class="c">!! シミュレーション時刻</span>
<a name="ln-556"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fluid</span>  <span class="c">!! 流体データ</span>
<a name="ln-557"></a>
<a name="ln-558"></a>    <span class="kt">integer</span><span class="p">(</span><span class="n">SI</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">SKIP</span> <span class="o">=</span> <span class="mi">100</span>
<a name="ln-559"></a>      <span class="c">! このルーチンは結構計算負荷が高いので、</span>
<a name="ln-560"></a>      <span class="c">! 毎ステップではなく、SKIPステップごとに診断を実行する</span>
<a name="ln-561"></a>
<a name="ln-562"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ABNORMALLY_LARGE</span> <span class="o">=</span> <span class="mf">1.e20_DR</span>
<a name="ln-563"></a>      <span class="c">! これよりも物理量が大きくなったら異常が生じたと判断する</span>
<a name="ln-564"></a>
<a name="ln-565"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__vector3d_t</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vel</span>
<a name="ln-566"></a>      <span class="c">! 流れの速度場</span>
<a name="ln-567"></a>
<a name="ln-568"></a>    <span class="k">if</span> <span class="p">(</span> <span class="nb">mod</span><span class="p">(</span><span class="n">nloop</span><span class="p">,</span><span class="n">SKIP</span><span class="p">)</span> <span class="o">/=</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">return</span>
<a name="ln-569"></a>      <span class="c">! このルーチンは結構計算負荷が高いので、</span>
<a name="ln-570"></a>      <span class="c">! 毎ステップではなく、SKIPステップごとに診断を実行する</span>
<a name="ln-571"></a>
<a name="ln-572"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">job__karte</span><span class="p">%</span><span class="n">state</span> <span class="o">/=</span> <span class="s2">&quot;fine&quot;</span> <span class="p">)</span> <span class="k">return</span> <span class="c">! Already in error state.</span>
<a name="ln-573"></a>      <span class="c">! ジョブの健康状態がfine（つまり健康）以外の値に</span>
<a name="ln-574"></a>      <span class="c">! 設定する可能性があるのはここ以外にもある（例えばmain.f90の</span>
<a name="ln-575"></a>      <span class="c">! メインループでシミュレーションのループカウンタが最大値が達するなど）</span>
<a name="ln-576"></a>      <span class="c">! そのような場合、どうせこの後、ジョブの停止処理に入るので、</span>
<a name="ln-577"></a>      <span class="c">! これ以上計算を進めなくてもよい。</span>
<a name="ln-578"></a>
<a name="ln-579"></a>    <span class="k">if</span> <span class="p">(</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ABNORMALLY_LARGE</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-580"></a>      <span class="c">! 質量フラックスのx成分の最大値が異常に大きい</span>
<a name="ln-581"></a>      <span class="c">! これはバグである。absを入れ忘れている。</span>
<a name="ln-582"></a>      <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s2">&quot;&lt;solver__diagnosis&gt; Massflux_x overflow.&quot;</span><span class="p">)</span>
<a name="ln-583"></a>      <span class="k">call </span><span class="n">job__karte</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;over_flow&quot;</span><span class="p">)</span>
<a name="ln-584"></a>      <span class="k">return</span>
<a name="ln-585"></a>        <span class="c">! これ以上計算しても無駄（すぐに終了処理に入るべし）</span>
<a name="ln-586"></a>    <span class="k">end if</span>
<a name="ln-587"></a>
<a name="ln-588"></a><span class="k">    if</span> <span class="p">(</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ABNORMALLY_LARGE</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-589"></a>      <span class="c">! 質量フラックスのy成分の最大値が異常に大きい</span>
<a name="ln-590"></a>      <span class="c">! これもバグである。absを入れ忘れている。</span>
<a name="ln-591"></a>      <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s2">&quot;&lt;solver__diagnosis&gt; Massflux_y overflow.&quot;</span><span class="p">)</span>
<a name="ln-592"></a>      <span class="k">call </span><span class="n">job__karte</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;over_flow&quot;</span><span class="p">)</span>
<a name="ln-593"></a>      <span class="k">return</span>
<a name="ln-594"></a>        <span class="c">! これ以上計算しても無駄（すぐに終了処理に入るべし）</span>
<a name="ln-595"></a>    <span class="k">end if</span>
<a name="ln-596"></a>
<a name="ln-597"></a><span class="k">    if</span> <span class="p">(</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ABNORMALLY_LARGE</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-598"></a>      <span class="c">! 質量フラックスのz成分の最大値が異常に大きい</span>
<a name="ln-599"></a>      <span class="c">! これもバグである。absを入れ忘れている。</span>
<a name="ln-600"></a>      <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s2">&quot;&lt;solver__diagnosis&gt; Massflux_z overflow.&quot;</span><span class="p">)</span>
<a name="ln-601"></a>      <span class="k">call </span><span class="n">job__karte</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;over_flow&quot;</span><span class="p">)</span>
<a name="ln-602"></a>      <span class="k">return</span>
<a name="ln-603"></a>        <span class="c">! これ以上計算しても無駄（すぐに終了処理に入るべし）</span>
<a name="ln-604"></a>    <span class="k">end if</span>
<a name="ln-605"></a>
<a name="ln-606"></a><span class="k">    if</span> <span class="p">(</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">density</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ABNORMALLY_LARGE</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-607"></a>      <span class="c">! 質量が異常に大きい</span>
<a name="ln-608"></a>      <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s2">&quot;&lt;solver__diagnosis&gt; Density overflow.&quot;</span><span class="p">)</span>
<a name="ln-609"></a>      <span class="k">call </span><span class="n">job__karte</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;over_flow&quot;</span><span class="p">)</span>
<a name="ln-610"></a>      <span class="k">return</span>
<a name="ln-611"></a>        <span class="c">! これ以上計算しても無駄（すぐに終了処理に入るべし）</span>
<a name="ln-612"></a>    <span class="k">end if</span>
<a name="ln-613"></a>
<a name="ln-614"></a><span class="k">    if</span> <span class="p">(</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">pressure</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ABNORMALLY_LARGE</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-615"></a>      <span class="c">! 圧力が異常に大きい</span>
<a name="ln-616"></a>      <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s2">&quot;&lt;solver__diagnosis&gt; Pressure overflow.&quot;</span><span class="p">)</span>
<a name="ln-617"></a>      <span class="k">call </span><span class="n">job__karte</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;over_flow&quot;</span><span class="p">)</span>
<a name="ln-618"></a>      <span class="k">return</span>
<a name="ln-619"></a>        <span class="c">! これ以上計算しても無駄（すぐに終了処理に入るべし）</span>
<a name="ln-620"></a>    <span class="k">end if</span>
<a name="ln-621"></a>
<a name="ln-622"></a><span class="k">    if</span> <span class="p">(</span> <span class="nb">minval</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">pressure</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0_DR</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-623"></a>      <span class="c">! 圧力が負になってしまっている</span>
<a name="ln-624"></a>      <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s2">&quot;&lt;solver__diagnosis&gt; Negative pressure.&quot;</span><span class="p">)</span>
<a name="ln-625"></a>      <span class="k">call </span><span class="n">job__karte</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;negative_anormaly&quot;</span><span class="p">)</span>
<a name="ln-626"></a>      <span class="k">return</span>
<a name="ln-627"></a>        <span class="c">! これ以上計算しても無駄（すぐに終了処理に入るべし）</span>
<a name="ln-628"></a>    <span class="k">end if</span>
<a name="ln-629"></a>
<a name="ln-630"></a><span class="k">    if</span> <span class="p">(</span> <span class="nb">minval</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">density</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0_DR</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-631"></a>      <span class="c">! 密度が負になってしまっている</span>
<a name="ln-632"></a>      <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s2">&quot;&lt;solver__diagnosis&gt; Negative density.&quot;</span><span class="p">)</span>
<a name="ln-633"></a>      <span class="k">call </span><span class="n">job__karte</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;negative_anormaly&quot;</span><span class="p">)</span>
<a name="ln-634"></a>      <span class="k">return</span>
<a name="ln-635"></a>        <span class="c">! これ以上計算しても無駄（すぐに終了処理に入るべし）</span>
<a name="ln-636"></a>    <span class="k">end if</span>
<a name="ln-637"></a>
<a name="ln-638"></a><span class="k">    call </span><span class="n">subfield_vel</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">vel</span><span class="p">)</span>
<a name="ln-639"></a>      <span class="c">! 基本流れデータから副次的な速度場データを求める</span>
<a name="ln-640"></a>
<a name="ln-641"></a>    <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;#max vel:&#39;</span><span class="p">,</span>      <span class="n">nloop</span><span class="p">,</span> <span class="nb">time</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-642"></a>                     <span class="nb">sqrt</span><span class="p">(</span><span class="nb">maxval</span><span class="p">(</span><span class="n">vel</span><span class="p">%</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vel</span><span class="p">%</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vel</span><span class="p">%</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
<a name="ln-643"></a>      <span class="c">! 速度の最大値（ベクトルの長さ）を計算し標準出力に書き出す</span>
<a name="ln-644"></a>      <span class="c">! わずか1行で書いているが、実際にはここにかなりの計算が</span>
<a name="ln-645"></a>      <span class="c">! 含まれている。vel%x**2という配列演算は実際には3重do loop</span>
<a name="ln-646"></a>      <span class="c">! であり、maxval関数はその引数の3次元配列をとっている。</span>
<a name="ln-647"></a>      <span class="c">! つまり全要素中の最大値をとっている。そして最後に</span>
<a name="ln-648"></a>      <span class="c">! sqrtをとって振幅（ベクトルの長さ）を計算している。</span>
<a name="ln-649"></a>
<a name="ln-650"></a>    <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;#flow energy: &#39;</span><span class="p">,</span> <span class="n">nloop</span><span class="p">,</span> <span class="nb">time</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-651"></a><span class="c">![                                    .energyintegral.fluid)</span>
<a name="ln-652"></a>                                       <span class="n">operator_energyintegral</span><span class="p">(</span><span class="n">fluid</span><span class="p">))</span>
<a name="ln-653"></a>      <span class="c">! ここでもFortranコンパイラが許せば.energyintegral.という</span>
<a name="ln-654"></a>      <span class="c">! 簡潔な演算子表現を使ったほうがよい。ここでもこの1行の</span>
<a name="ln-655"></a>      <span class="c">! 実行にはかなりの演算（速度ベクトル場のx,y,z3成分の2乗和に</span>
<a name="ln-656"></a>      <span class="c">! 資料密度を掛けたもの体積積分）が必要であることに注意。</span>
<a name="ln-657"></a>
<a name="ln-658"></a>    <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;#total mass: &#39;</span><span class="p">,</span>  <span class="n">nloop</span><span class="p">,</span> <span class="nb">time</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-659"></a><span class="c">![                                    .scalarintegral.(fluid%density))</span>
<a name="ln-660"></a>                               <span class="n">operator_scalarintegral</span><span class="p">(</span><span class="n">fluid</span><span class="p">%</span><span class="n">density</span><span class="p">))</span>
<a name="ln-661"></a>      <span class="c">! 上と同様。こちらのほうは単なる密度場の体積積分なので</span>
<a name="ln-662"></a>      <span class="c">! 演算量は少ないが、シミュレーション領域全体に渡る体積積分</span>
<a name="ln-663"></a>      <span class="c">! なので計算量は大きいことに間違いない。</span>
<a name="ln-664"></a>
<a name="ln-665"></a>    <span class="k">call </span><span class="n">debug__print</span><span class="p">(</span><span class="s1">&#39;called solver__diagnosis.&#39;</span><span class="p">)</span>
<a name="ln-666"></a>      <span class="c">! デバッグモードがonの時には毎回メッセージを標準出力に</span>
<a name="ln-667"></a>      <span class="c">! 書き出す。コードが完成し、product runの段階に入ったら</span>
<a name="ln-668"></a>      <span class="c">! デバッグモードをoffにすれば、書き出しは抑制される。</span>
<a name="ln-669"></a>      <span class="c">! この行をコメントアウトする必要はない。</span>
<a name="ln-670"></a>  <span class="k">end subroutine </span><span class="n">solver__diagnosis</span>
<a name="ln-671"></a>
<a name="ln-672"></a>
<a name="ln-673"></a>  <span class="k">subroutine </span><span class="n">solver__initialize</span><span class="p">(</span><span class="n">fluid</span><span class="p">)</span>
<a name="ln-674"></a>    <span class="c">!! モジュールの初期化</span>
<a name="ln-675"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fluid</span>  <span class="c">!! 流体データ</span>
<a name="ln-676"></a>
<a name="ln-677"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">kappa</span>  <span class="c">! 空気の熱拡散率</span>
<a name="ln-678"></a>
<a name="ln-679"></a>    <span class="c">! 物理パラメータの設定</span>
<a name="ln-680"></a>    <span class="n">Viscosity</span> <span class="o">=</span> <span class="n">params__get_double</span><span class="p">(</span><span class="s1">&#39;Viscosity&#39;</span><span class="p">)</span> <span class="c">! 空気の粘性率</span>
<a name="ln-681"></a>    <span class="n">kappa</span>     <span class="o">=</span> <span class="n">params__get_double</span><span class="p">(</span><span class="s1">&#39;Kappa&#39;</span><span class="p">)</span>     <span class="c">! 空気の熱拡散率</span>
<a name="ln-682"></a>      <span class="c">! Viscosityと違ってkappaの頭文字が大文字になっていない、つまり</span>
<a name="ln-683"></a>      <span class="c">! このモジュールのグローバルスコープを持つ変数としていない</span>
<a name="ln-684"></a>      <span class="c">! のはナビエ・ストークス方程式には下で定義するGamma1_kappa</span>
<a name="ln-685"></a>      <span class="c">! という量のみを通じてkappaが出てくるからである。</span>
<a name="ln-686"></a>
<a name="ln-687"></a>    <span class="n">Gamma1_kappa</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Gamma</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">kappa</span>
<a name="ln-688"></a>      <span class="c">! gammaは比熱比、つまり定積比熱と定圧比熱の比である。</span>
<a name="ln-689"></a>      <span class="c">! 統計力学で習うように、この値は流体（気体）を構成する</span>
<a name="ln-690"></a>      <span class="c">! 分子の構造（自由度）で決まる。</span>
<a name="ln-691"></a>
<a name="ln-692"></a>    <span class="c">! 流体の初期条件の設定</span>
<a name="ln-693"></a>    <span class="n">fluid</span><span class="p">%</span><span class="n">pressure</span> <span class="o">=</span> <span class="mf">1.013e5_DR</span>  <span class="c">! 1013 hPa (一気圧)</span>
<a name="ln-694"></a>    <span class="n">fluid</span><span class="p">%</span><span class="n">density</span>  <span class="o">=</span> <span class="mf">1.293_DR</span>    <span class="c">! kg/m^3 (空気の密度)</span>
<a name="ln-695"></a><span class="c">![  fluid%flux     = 0.0_DR      ! 初期速度なし（流れなし）</span>
<a name="ln-696"></a>    <span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">x</span>   <span class="o">=</span> <span class="mf">0.0_DR</span>      <span class="c">! 初期速度なし（流れなし）</span>
<a name="ln-697"></a>    <span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">y</span>   <span class="o">=</span> <span class="mf">0.0_DR</span>        
<a name="ln-698"></a>    <span class="n">fluid</span><span class="p">%</span><span class="n">flux</span><span class="p">%</span><span class="n">z</span>   <span class="o">=</span> <span class="mf">0.0_DR</span>       
<a name="ln-699"></a>      <span class="c">! コンパイラが許す場合は上の簡潔な代入表現の方が望ましい</span>
<a name="ln-700"></a>
<a name="ln-701"></a>    <span class="c">! 渦輪を駆動するための力の場の設定</span>
<a name="ln-702"></a>    <span class="k">call </span><span class="n">set_drive_force_field</span>
<a name="ln-703"></a>
<a name="ln-704"></a>    <span class="n">Initialize_done</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-705"></a>      <span class="c">! モジュール初期化終了フラグ</span>
<a name="ln-706"></a>
<a name="ln-707"></a>    <span class="k">call </span><span class="n">debug__print</span><span class="p">(</span><span class="s2">&quot;called solver__initialize.&quot;</span><span class="p">)</span>
<a name="ln-708"></a>      <span class="c">! デバッグモードがonの時には毎回メッセージを標準出力に</span>
<a name="ln-709"></a>      <span class="c">! 書き出す。コードが完成し、product runの段階に入ったら</span>
<a name="ln-710"></a>      <span class="c">! デバッグモードをoffにすれば、書き出しは抑制される。</span>
<a name="ln-711"></a>      <span class="c">! この行をコメントアウトする必要はない。</span>
<a name="ln-712"></a>  <span class="k">end subroutine </span><span class="n">solver__initialize</span>
<a name="ln-713"></a>
<a name="ln-714"></a>
<a name="ln-715"></a>  <span class="k">function </span><span class="n">solver__set_time_step</span><span class="p">(</span><span class="n">nloop</span><span class="p">,</span><span class="n">fluid</span><span class="p">)</span>
<a name="ln-716"></a>    <span class="c">!! CFL条件に基づいて時間刻み幅dtを設定する</span>
<a name="ln-717"></a>    <span class="kt">integer</span><span class="p">(</span><span class="n">DI</span><span class="p">),</span>          <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nloop</span>  <span class="c">!! ループカウンタ</span>
<a name="ln-718"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__fluid_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fluid</span>  <span class="c">!! 流体データ</span>
<a name="ln-719"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">solver__set_time_step</span> <span class="c">!! 時間刻み幅 dt</span>
<a name="ln-720"></a>
<a name="ln-721"></a>    <span class="k">type</span><span class="p">(</span><span class="n">field__vector3d_t</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">vel</span> <span class="c">! 速度場</span>
<a name="ln-722"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">NX</span><span class="p">,</span><span class="n">NY</span><span class="p">,</span><span class="n">NZ</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tm</span>  <span class="c">! 温度場</span>
<a name="ln-723"></a>
<a name="ln-724"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">sound_v</span> 
<a name="ln-725"></a>      <span class="c">! 流れ速度の最大値と音速</span>
<a name="ln-726"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dt_vel</span><span class="p">,</span> <span class="n">dt_sound</span><span class="p">,</span> <span class="n">dt_viscous</span><span class="p">,</span> <span class="n">dt_kappa</span>
<a name="ln-727"></a>      <span class="c">! 流れ速度、音波、粘性拡散、熱拡散、それぞれで決まる時間刻み幅</span>
<a name="ln-728"></a>      <span class="c">! 実際のdtはこれらのなかで最も厳しい（小さい）値できまる。</span>
<a name="ln-729"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ALMOST_ZERO</span> <span class="o">=</span> <span class="mf">1.e-20_DR</span> 
<a name="ln-730"></a>      <span class="c">! ゼロ割り演算回避のためにつかう小さい値</span>
<a name="ln-731"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ABNORMAL_VALUE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span><span class="mf">9.999_DR</span> 
<a name="ln-732"></a>      <span class="c">! dtとしてありそうにない値（すぐ下で使う）</span>
<a name="ln-733"></a>    <span class="kt">real</span><span class="p">(</span><span class="n">DR</span><span class="p">),</span> <span class="k">save</span> <span class="kd">::</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">ABNORMAL_VALUE</span>
<a name="ln-734"></a>      <span class="c">! 時間刻み幅そのもの。初期設定でなんらかの失敗した場合</span>
<a name="ln-735"></a>      <span class="c">! を検出するため最初はありそうない値を設定しておくが、</span>
<a name="ln-736"></a>      <span class="c">! CFL条件に基づいて正しい値を一度設定したらその後は</span>
<a name="ln-737"></a>      <span class="c">! この宣言文にはsave属性がついているので、</span>
<a name="ln-738"></a>      <span class="c">! この関数を抜けたあともその値を覚えている。</span>
<a name="ln-739"></a>    <span class="kt">integer</span><span class="p">(</span><span class="n">SI</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">SKIP</span> <span class="o">=</span> <span class="mi">20</span>
<a name="ln-740"></a>      <span class="c">! dtを毎ステップ計算するのは大変（かなりの時間がかかる）</span>
<a name="ln-741"></a>      <span class="c">! のでこのSKIPステップに一度だけ計算する。毎ステップ計算する</span>
<a name="ln-742"></a>      <span class="c">! してもdtは1ステップでそれほど大きく変化しないからである。</span>
<a name="ln-743"></a>      <span class="c">! ただし、計算が破綻（発散）するような場合は例外である。</span>
<a name="ln-744"></a>
<a name="ln-745"></a>    <span class="k">call </span><span class="n">ut__assert</span><span class="p">(</span><span class="n">Initialize_done</span><span class="p">,</span><span class="s2">&quot;&lt;solver__set_tim_step&gt; Forgot init?&quot;</span><span class="p">)</span>
<a name="ln-746"></a>      <span class="c">! 初期化忘れ確認</span>
<a name="ln-747"></a>
<a name="ln-748"></a>    <span class="k">if</span> <span class="p">(</span> <span class="nb">mod</span><span class="p">(</span><span class="n">nloop</span><span class="p">,</span><span class="n">SKIP</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">then</span> <span class="c">! ほとんどの場合は、前回計算したdtを使う。</span>
<a name="ln-749"></a>      <span class="k">call </span><span class="n">subfield_vel_tm</span><span class="p">(</span><span class="n">fluid</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="n">tm</span><span class="p">)</span>
<a name="ln-750"></a>        <span class="c">! 基本流体データから速度場と温度場を計算</span>
<a name="ln-751"></a>
<a name="ln-752"></a>      <span class="n">vmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">vel</span><span class="p">%</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vel</span><span class="p">%</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vel</span><span class="p">%</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-753"></a>        <span class="c">! 速度の最大値（ベクトルの長さの最大値）をもとめる</span>
<a name="ln-754"></a>        <span class="c">! ここでは配列演算を駆使して1行で書いているが</span>
<a name="ln-755"></a>        <span class="c">! 実際にはかなりの演算をしていることに注意。</span>
<a name="ln-756"></a>        <span class="c">! これはバグではないが、maxvalとsqrtは交換すべき</span>
<a name="ln-757"></a>        <span class="c">! だろう。このままだと3次元配列の全要素にsqrt</span>
<a name="ln-758"></a>        <span class="c">! を掛けてからそのmaxvalをとっているが、これを</span>
<a name="ln-759"></a>        <span class="c">! 逆にした方が速いかもしれない。</span>
<a name="ln-760"></a>
<a name="ln-761"></a>      <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span><span class="n">ALMOST_ZERO</span><span class="p">)</span> 
<a name="ln-762"></a>        <span class="c">! 初期条件では速度場がゼロなのでvmax=0となるが、あとで</span>
<a name="ln-763"></a>        <span class="c">! vmaxの割り算が出てくるので問題となる。それを回避するため</span>
<a name="ln-764"></a>        <span class="c">! ALMOST_ZEROが十分小さければよい。</span>
<a name="ln-765"></a>
<a name="ln-766"></a>      <span class="n">sound_v</span> <span class="o">=</span> <span class="nb">GAMMA</span><span class="o">*</span><span class="nb">maxval</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">GASS_CONST_FOR_AIR</span><span class="o">*</span><span class="n">tm</span><span class="p">))</span> 
<a name="ln-767"></a>        <span class="c">! 音速の最大値</span>
<a name="ln-768"></a>        <span class="c">! これも上と同じ理屈で、maxvalとsqrtは交換すべき</span>
<a name="ln-769"></a>        <span class="c">! だろう。このままだと3次元配列の全要素にsqrt</span>
<a name="ln-770"></a>        <span class="c">! を掛けてからそのmaxvalをとっているが、これを</span>
<a name="ln-771"></a>        <span class="c">! 逆にした方が速いかもしれない。</span>
<a name="ln-772"></a>
<a name="ln-773"></a>      <span class="k">call </span><span class="n">ut__assert</span><span class="p">(</span><span class="n">sound_v</span> <span class="o">&gt;</span> <span class="n">ALMOST_ZERO</span><span class="p">,</span><span class="s2">&quot;&lt;solver__time_step&gt; sound_v=0?&quot;</span><span class="p">)</span>
<a name="ln-774"></a>        <span class="c">! 音速（の最大値）がほとんどゼロになるのは</span>
<a name="ln-775"></a>        <span class="c">! 何かがおかしいのですぐに停止</span>
<a name="ln-776"></a>
<a name="ln-777"></a>      <span class="c">! 以下では、流れの速さ、音波、粘性拡散、熱拡散の4種類の</span>
<a name="ln-778"></a>      <span class="c">! CFL条件で決まる時間刻み幅をそれぞれこの順番に求めている。</span>
<a name="ln-779"></a>      <span class="n">dt_vel</span>     <span class="o">=</span> <span class="mf">0.8_DR</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">delta_min</span><span class="o">/</span><span class="n">vmax</span>
<a name="ln-780"></a>      <span class="n">dt_sound</span>   <span class="o">=</span> <span class="mf">0.8_DR</span><span class="o">*</span><span class="n">grid</span><span class="p">%</span><span class="n">delta_min</span><span class="o">/</span><span class="n">sound_v</span>
<a name="ln-781"></a>      <span class="n">dt_viscous</span> <span class="o">=</span> <span class="mf">0.2_DR</span><span class="o">*</span><span class="p">(</span><span class="n">grid</span><span class="p">%</span><span class="n">delta_min</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">Viscosity</span>
<a name="ln-782"></a>      <span class="n">dt_kappa</span>   <span class="o">=</span> <span class="mf">0.2_DR</span><span class="o">*</span><span class="p">(</span><span class="n">grid</span><span class="p">%</span><span class="n">delta_min</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">Gamma1_kappa</span>
<a name="ln-783"></a>        <span class="c">! CFL factor はここでは0.8と0.2にしているが、</span>
<a name="ln-784"></a>        <span class="c">! これは精密な議論に基づいて決めたものではなく、</span>
<a name="ln-785"></a>        <span class="c">! 半経験的に決めた値である。</span>
<a name="ln-786"></a>        <span class="c">! 最後の2つ、粘性拡散と熱拡散によるCFL条件のための</span>
<a name="ln-787"></a>        <span class="c">! CFL factor の値 (0.2) というのは少々安全側に設定</span>
<a name="ln-788"></a>        <span class="c">! しすぎているかもしれない。つまりもう少し大きくしても</span>
<a name="ln-789"></a>        <span class="c">! 問題ないかもしれない。</span>
<a name="ln-790"></a>
<a name="ln-791"></a>      <span class="n">dt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dt_vel</span><span class="p">,</span> <span class="n">dt_sound</span><span class="p">,</span> <span class="n">dt_viscous</span><span class="p">,</span> <span class="n">dt_kappa</span><span class="p">)</span>
<a name="ln-792"></a>        <span class="c">! 最終的な時間刻み幅は上記の4種類のdtの最小値できまる。</span>
<a name="ln-793"></a>
<a name="ln-794"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">params__get_logical</span><span class="p">(</span><span class="s1">&#39;Debug&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-795"></a>        <span class="c">! デバッグモードがonであるとき、以下のデータを標準出力</span>
<a name="ln-796"></a>        <span class="c">! に書き出す。出力が長くなるが、流体の状態を推測するのに</span>
<a name="ln-797"></a>        <span class="c">! 便利なデータである。</span>
<a name="ln-798"></a>        <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;&lt;solver__time_step&gt; vmax = &#39;</span><span class="p">,</span> <span class="n">vmax</span>       <span class="p">)</span>
<a name="ln-799"></a>        <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;                  dt_vel = &#39;</span><span class="p">,</span> <span class="n">dt_vel</span>     <span class="p">)</span>
<a name="ln-800"></a>        <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;                dt_sound = &#39;</span><span class="p">,</span> <span class="n">dt_sound</span>   <span class="p">)</span>
<a name="ln-801"></a>        <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;                dt_kappa = &#39;</span><span class="p">,</span> <span class="n">dt_kappa</span>   <span class="p">)</span>
<a name="ln-802"></a>        <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;              dt_viscous = &#39;</span><span class="p">,</span> <span class="n">dt_viscous</span> <span class="p">)</span>
<a name="ln-803"></a>        <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s1">&#39;               --&gt;    dt = &#39;</span><span class="p">,</span> <span class="n">dt</span>         <span class="p">)</span>
<a name="ln-804"></a>      <span class="k">end if</span>
<a name="ln-805"></a>
<a name="ln-806"></a><span class="k">      if</span> <span class="p">(</span> <span class="nb">mod</span><span class="p">(</span><span class="n">nloop</span><span class="p">,</span><span class="n">SKIP</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span>  <span class="k">call </span><span class="n">ut__message</span><span class="p">(</span><span class="s2">&quot;&gt; dt = &quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<a name="ln-807"></a>        <span class="c">! dtの値を（デバッグモードがoffであっても）書き出す</span>
<a name="ln-808"></a>        <span class="c">! SKIPをさら50倍しているのは、それほど頻繁に出力する</span>
<a name="ln-809"></a>        <span class="c">! 必要は通常ないからである。</span>
<a name="ln-810"></a>
<a name="ln-811"></a>    <span class="k">end if</span>
<a name="ln-812"></a>
<a name="ln-813"></a><span class="k">    call </span><span class="n">ut__assert</span><span class="p">(</span><span class="n">dt</span> <span class="o">/=</span> <span class="n">ABNORMAL_VALUE</span><span class="p">,</span> <span class="s2">&quot;&lt;solver__time_step&gt; dt init failed?&quot;</span><span class="p">)</span>
<a name="ln-814"></a>      <span class="c">! SKIPに一度dtを計算し直すが、それ以外は下の行を見れば分かる通り</span>
<a name="ln-815"></a>      <span class="c">! 前回のdtの値を流用する。 その際、一度もdtを計算したことがなかったら</span>
<a name="ln-816"></a>      <span class="c">! まずいのでその検出をABNORMAL_VALUEを使って検出している。</span>
<a name="ln-817"></a>
<a name="ln-818"></a>    <span class="n">solver__set_time_step</span> <span class="o">=</span> <span class="n">dt</span>    <span class="c">! dt of the prev calc is saved.</span>
<a name="ln-819"></a>      <span class="c">! 新たに更新（または前回計算した）dtを返す。</span>
<a name="ln-820"></a>  <span class="k">end function </span><span class="n">solver__set_time_step</span>
<a name="ln-821"></a>
<a name="ln-822"></a><span class="k">end module </span><span class="n">solver_m</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2020 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2020-01-23 09:25  
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> Smoke Ring was developed by </p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>